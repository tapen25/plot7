<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian Hardbass x Nature Glitch</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #0f0; 
            text-align: center; 
            padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 90vh; overflow: hidden;
        }
        
        #playBtn {
            padding: 20px 40px; 
            font-size: 1.2rem; font-weight: bold;
            background: #000; color: #0f0; 
            border: 2px solid #0f0; border-radius: 0;
            cursor: pointer; transition: all 0.2s;
        }
        #playBtn:hover { background: #0f0; color: #000; }
        
        .status-box {
            border: 1px solid #333; padding: 20px; width: 80%; max-width: 400px; margin-top: 30px;
        }
        .val { font-size: 2.5rem; font-weight: bold; }
        .label { color: #555; font-size: 0.8rem; margin-top: 10px; }
        
        #event-log {
            height: 30px; margin-top: 10px; color: #fff; font-weight: bold;
            text-shadow: 0 0 5px #fff;
        }
    </style>
</head>
<body>

    <button id="playBtn">INITIATE SEQUENCE</button>

    <div class="status-box">
        <div id="event-log"></div>
        <div class="label">CURRENT BPM</div>
        <div class="val" id="bpmVal">---</div>
        <div class="label">SPEED INTENSITY</div>
        <div class="val" id="speedVal">0%</div>
    </div>

<script>
// ==========================================
// 1. ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°
// ==========================================
let isPlaying = false;
let smoothedActivity = 0.0;
const motionBuffer = [];

// A Harmonic Minor (Hardbass Scale)
const scale = ["A3", "B3", "C4", "D4", "E4", "F4", "G#4", "A4"];

// ==========================================
// 2. éŸ³æºã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ==========================================
let kick, bass, snare, hihat, lead;
let birdSynth, birdPan;
let windNode, windFilter, windGain;
let masterLimiter, reverb;

function setupAudio() {
    masterLimiter = new Tone.Limiter(-0.5).toDestination();
    reverb = new Tone.Reverb({ decay: 3, wet: 0.4 }).connect(masterLimiter); // æ·±ã‚ã®ãƒªãƒãƒ¼ãƒ–ã§ç©ºé–“è¡¨ç¾

    // --- Hardbass Section ---
    kick = new Tone.MembraneSynth({
        pitchDecay: 0.05, octaves: 8, oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.8 },
        volume: 0
    }).connect(masterLimiter);

    bass = new Tone.FMSynth({
        harmonicity: 3.01, modulationIndex: 15, oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0.1, release: 0.1 },
        modulation: { type: "square" }, volume: -2
    }).connect(masterLimiter);

    snare = new Tone.NoiseSynth({
        noise: { type: "white" }, envelope: { attack: 0.001, decay: 0.15 }, volume: -8
    }).connect(reverb);

    hihat = new Tone.MetalSynth({
        frequency: 200, envelope: { decay: 0.05 }, harmonicity: 5.1, volume: -15
    }).connect(masterLimiter);

    lead = new Tone.Synth({
        oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.1 }, volume: -12
    }).connect(reverb);

    // --- Nature / Accidental FX Section ---
    
    // 1. Bird Synth (å·¦å³ã«å‹•ã)
    birdPan = new Tone.Panner(0).connect(reverb);
    birdSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 },
        volume: -10
    }).connect(birdPan);

    // 2. Wind (é¢¨)
    windFilter = new Tone.Filter(300, "bandpass");
    windGain = new Tone.Gain(0).connect(masterLimiter);
    windNode = new Tone.Noise("pink").connect(windFilter).connect(windGain);
    windNode.start();
}

// ==========================================
// 3. å¶ç™ºã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
// ==========================================

// é³¥ã®é³´ãå£°ã‚’ç”Ÿæˆ (Activityã«ã‚ˆã£ã¦å¤‰åŒ–)
function triggerRandomBird(act, time) {
    // ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«
    birdPan.pan.value = (Math.random() * 2) - 1;
    
    if (act < 0.3) {
        // Mode: PEACEFUL (å¯æ„›ã„ã•ãˆãšã‚Š)
        const freq = 1500 + Math.random() * 1000;
        birdSynth.triggerAttackRelease(freq, "32n", time);
        // 50%ã§2å›é³´ã (ãƒãƒ¥ãƒ³ãƒãƒ¥ãƒ³)
        if(Math.random() > 0.5) {
            birdSynth.triggerAttackRelease(freq + 200, "32n", time + 0.1);
        }
        showLog("ğŸ¦ CHIRP");
    } else {
        // Mode: GLITCH (ãƒã‚°ã£ãŸé³¥ = é›»å­éŸ³çš„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ)
        // é«˜é€Ÿã§ãƒ”ãƒƒãƒã‚’å¤‰ãˆã¦FXã«ã™ã‚‹
        const freq = 800 + Math.random() * 500;
        birdSynth.triggerAttackRelease(freq, "64n", time);
        birdSynth.triggerAttackRelease(freq * 1.5, "64n", time + 0.05);
        birdSynth.triggerAttackRelease(freq * 2.0, "64n", time + 0.1);
        showLog("âš¡ BIRD GLITCH");
    }
}

// çªé¢¨ã‚’ç”Ÿæˆ
function triggerGust(time) {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‹ã„ã¦éŸ³é‡ã‚’ä¸Šã’ã‚‹ï¼ˆãƒ’ãƒ¥ã‚ªãƒƒï¼ï¼‰
    windFilter.frequency.rampTo(800, 0.1, time);
    windGain.gain.rampTo(0.6, 0.1, time);
    
    // ã™ãæˆ»ã™
    windFilter.frequency.rampTo(200, 1.5, time + 0.2);
    windGain.gain.rampTo(0.1, 1.5, time + 0.2);
    
    showLog("ğŸ’¨ GUST");
}

function showLog(msg) {
    const el = document.getElementById('event-log');
    el.innerText = msg;
    el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, 500);
}

// ==========================================
// 4. ã‚·ãƒ¼ã‚±ãƒ³ã‚µãƒ¼
// ==========================================
let tick = 0;

function startLoop() {
    Tone.Transport.bpm.value = 90;

    Tone.Transport.scheduleRepeat((time) => {
        const act = smoothedActivity;
        const beat16 = tick % 16;
        const beat4 = tick % 4;

        // --- å¶ç™ºã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š (Random Chance) ---
        // é³¥: ActivityãŒä½ã„ã»ã©é³´ãã‚„ã™ã„ãŒã€é«˜ãã¦ã‚‚ã‚°ãƒªãƒƒãƒã¨ã—ã¦é³´ã‚‹
        let birdChance = act < 0.3 ? 0.1 : 0.05; 
        if (Math.random() < birdChance) triggerRandomBird(act, time);

        // é¢¨: ActivityãŒé«˜ã„ã»ã©ã€Œçªé¢¨ã€ãŒå¹ãã‚„ã™ã„
        let windChance = act > 0.5 ? 0.05 : 0.01;
        if (Math.random() < windChance) triggerGust(time);

        // --- Russian Beat Logic ---
        
        // KICK (4/4)
        if (beat4 === 0) kick.triggerAttackRelease("A1", "8n", time);

        // BASS (è£æ‰“ã¡) - Activity 0.3ä»¥ä¸Šã§ç™ºå‹•
        if (act > 0.3 && beat4 === 2) {
            bass.triggerAttackRelease("A2", "8n", time);
        }

        // PERCUSSION
        if (act > 0.5) {
            if (beat16 % 8 === 4) snare.triggerAttackRelease("8n", time);
            if (beat4 === 2) hihat.triggerAttackRelease("32n", time);
        }

        // MELODY (Arpeggio)
        if (act > 0.2) {
            // ActivityãŒé«˜ã„ã¨éŸ³æ•°ãŒå¢—ãˆã‚‹
            const density = act > 0.7 ? 2 : 4; // 2=8åˆ†, 4=4åˆ†
            if (tick % density === 0) {
                // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ãƒ«ãƒšã‚¸ã‚ª
                const note = scale[Math.floor(Math.random() * scale.length)];
                leadSynth.triggerAttackRelease(note, "16n", time);
            }
        }

        tick++;
    }, "16n");

    Tone.Transport.start();
}

// ==========================================
// 5. æ›´æ–°ãƒ«ãƒ¼ãƒ—
// ==========================================
function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    // ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
    const raw = motionBuffer.length ? motionBuffer[motionBuffer.length-1] : 0;
    smoothedActivity += (raw - smoothedActivity) * 0.05;

    // BPMåˆ¶å¾¡ (90 -> 170)
    // ã‚«ãƒ¼ãƒ–ã‚’æ€¥ã«ã—ã¦ã€Œå°‘ã—èµ°ã‚‹ã¨ã™ãæˆ¦é—˜ãƒ¢ãƒ¼ãƒ‰ã€ã«ã™ã‚‹
    const targetBpm = 90 + (Math.pow(smoothedActivity, 0.5) * 80);
    Tone.Transport.bpm.rampTo(targetBpm, 0.1);

    // å¸¸æ™‚é³´ã‚‹ãƒ™ãƒ¼ã‚¹ã®é¢¨éŸ³é‡ (çªé¢¨ã¨ã¯åˆ¥)
    // èµ°ã£ã¦ã„ã‚‹ã¨ãã¯å¸¸ã«å°‘ã—é¢¨åˆ‡ã‚ŠéŸ³ãŒã™ã‚‹
    const baseWindVol = smoothedActivity * 0.2;
    // çªé¢¨ã‚¤ãƒ™ãƒ³ãƒˆã§æ›¸ãæ›ã‚ã£ã¦ã„ãªã„æ™‚ã ã‘æ›´æ–°ï¼ˆç°¡æ˜“åˆ¶å¾¡ï¼‰
    if(windGain.gain.value < baseWindVol) {
        windGain.gain.rampTo(baseWindVol, 0.1);
    }

    // UIæ›´æ–°
    document.getElementById('bpmVal').innerText = Math.round(targetBpm);
    document.getElementById('speedVal').innerText = Math.round(smoothedActivity * 100) + "%";
}

// ==========================================
// 6. ã‚»ãƒ³ã‚µãƒ¼ & åˆæœŸåŒ–
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
    const normalized = Math.min(Math.abs(mag - 9.8) / 6.0, 1.0);
    motionBuffer.push(normalized);
    if(motionBuffer.length > 10) motionBuffer.shift();
}

document.getElementById('playBtn').addEventListener('click', async () => {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const state = await DeviceMotionEvent.requestPermission();
        if (state !== 'granted') return alert("Permission Denied");
    }
    window.addEventListener('devicemotion', handleMotion);
    await Tone.start();
    setupAudio();
    startLoop();
    isPlaying = true;
    update();
    document.getElementById('playBtn').style.display = 'none';
});
</script>
</body>
</html>