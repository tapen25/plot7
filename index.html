<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Synth – Discrete BPM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; }
  button { padding: 15px 30px; font-size: 1.2em; }
  #status, #debug { margin: 15px 0; }
  #debug { color: #666; font-size: 0.9em; }
</style>
</head>
<body>

<button id="start">Start (iOSは要タップ)</button>
<div id="status">停止中</div>
<div id="debug">avgMag: 0 / BPM: 100</div>

<script>
// ===============================
// Tone.js Synth 定義
// ===============================
const polySynth = new Tone.PolySynth(Tone.Synth, {
  oscillator: { type: "triangle" },
  envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
}).toDestination();

const fmSynth = new Tone.FMSynth({
  harmonicity: 3,
  modulationIndex: 10,
  oscillator: { type: "sine" },
  envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
  modulation: { type: "square" },
  volume: -6
}).toDestination();

const monoSynth = new Tone.MonoSynth({
  oscillator: { type: "square" },
  filter: { Q: 6, type: "lowpass" },
  envelope: { attack: 0.005, decay: 0.1, sustain: 0.9, release: 1 },
  filterEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 2, baseFrequency: 200, octaves: 6 }
}).toDestination();

// ===============================
// 音楽データ
// ===============================
const patterns = {
  A: ["D4","C4","B3","D4","C4","A3","G3","A3","B3"],
  B: ["D4","C4","B3","D4","C4","A3","G3","B3","G3"]
};

const durations = [0.25,0.25,0.25,0.25,0.5,0.5,0.5,0.5,1.0];

// ===============================
// 状態変数
// ===============================
let usePatternA = true;
let isPlaying = false;
let noteIndex = 0;

let motionHistory = [];
const HISTORY_DURATION = 2000;

// ===============================
// BPM 段階設計（100–120）
// ===============================
const bpmLevels = [
  { min: -Infinity, max: 9.5, bpm: 100 },
  { min: 9.5, max: 10.5, bpm: 105 },
  { min: 10.5, max: 11.5, bpm: 110 },
  { min: 11.5, max: 12.5, bpm: 115 },
  { min: 12.5, max: Infinity, bpm: 120 }
];

let currentBPM = 100;
let bpmCandidate = 100;
let bpmChangeTime = 0;
const BPM_HOLD_TIME = 1000;

Tone.Transport.bpm.value = currentBPM;

// ===============================
// Start
// ===============================
document.getElementById("start").onclick = async () => {
  await Tone.start();
  if (typeof DeviceMotionEvent?.requestPermission === "function") {
    await DeviceMotionEvent.requestPermission();
  }
  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "センサー待機中";
  document.getElementById("start").style.display = "none";
};

// ===============================
// センサー処理
// ===============================
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  motionHistory.push({ time: now, val: mag });
  motionHistory = motionHistory.filter(d => now - d.time < HISTORY_DURATION);

  const avgMag = motionHistory.reduce((s,d)=>s+d.val,0) / motionHistory.length;
  updateBPM(avgMag);

  document.getElementById("debug").innerText =
    `avgMag: ${avgMag.toFixed(2)} / BPM: ${currentBPM}`;

  if (!isPlaying && mag > 15) startSequence();
}

// ===============================
// avgMag → BPM（段階）
// ===============================
function accelToBPM(avgMag) {
  return bpmLevels.find(l => avgMag >= l.min && avgMag < l.max).bpm;
}

function updateBPM(avgMag) {
  const now = performance.now();
  const newBPM = accelToBPM(avgMag);

  if (newBPM !== bpmCandidate) {
    bpmCandidate = newBPM;
    bpmChangeTime = now;
  }

  if (newBPM !== currentBPM && now - bpmChangeTime > BPM_HOLD_TIME) {
    currentBPM = newBPM;
    Tone.Transport.bpm.rampTo(currentBPM, 0.5);
  }
}

// ===============================
// シーケンス制御
// ===============================
function startSequence() {
  isPlaying = true;
  noteIndex = 0;
  playNext();
}

function playNext() {
  const pattern = usePatternA ? patterns.A : patterns.B;
  if (noteIndex >= pattern.length) return finish();

  const note = pattern[noteIndex];
  const dur = durations[noteIndex];
  const sec = (60 / currentBPM) * dur;

  const isHigh = currentBPM >= 115;
  const synth = isHigh ? monoSynth : (usePatternA ? polySynth : fmSynth);

  synth.triggerAttackRelease(note, sec);

  document.getElementById("status").innerText =
    `再生中 Pattern ${usePatternA ? "A" : "B"} / BPM ${currentBPM}`;

  setTimeout(() => { noteIndex++; playNext(); }, sec * 1000);
}

function finish() {
  isPlaying = false;
  usePatternA = !usePatternA;
  document.getElementById("status").innerText = "待機中";
}
</script>
</body>
</html>