<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motion → BPM → Tone.js</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #f2f2f2;
    padding: 20px;
  }
  button {
    font-size: 1.2rem;
    padding: 15px 30px;
  }
  .info {
    margin-top: 20px;
    font-size: 1rem;
  }
</style>
</head>

<body>
<h2>Walking Music Interaction</h2>
<button id="startBtn">Start (iOS用)</button>

<div class="info">
  <div id="activity">Activity: 0</div>
  <div id="bpm">BPM: 100</div>
  <div id="mode">Mode: calm</div>
</div>

<script>
/* ===============================
   加速度処理
================================ */
let accelHistory = [];
const WINDOW_SIZE = 20;

function calcStdDev(values) {
  const mean = values.reduce((a, b) => a + b, 0) / values.length;
  const variance =
    values.reduce((sum, v) => sum + (v - mean) ** 2, 0) / values.length;
  return Math.sqrt(variance);
}

function getActivity() {
  if (accelHistory.length < WINDOW_SIZE) return 0;
  return calcStdDev(accelHistory);
}

/* ===============================
   Activity → BPM
================================ */
function activityToBPM(activity) {
  const minA = 0.5;
  const maxA = 3.0;
  const clamped = Math.max(minA, Math.min(maxA, activity));
  const norm = (clamped - minA) / (maxA - minA);
  return 100 + norm * 20;
}

/* ===============================
   Tone.js
================================ */
let synth = null;
let currentMode = "";
const loop = new Tone.Loop(time => {
  synth?.triggerAttackRelease("D4", "8n", time);
}, "4n");

function setSynthByBPM(bpm) {
  let mode = "";

  if (bpm < 110) mode = "calm";
  else if (bpm < 120) mode = "active";
  else mode = "energetic";

  if (mode === currentMode) return;
  currentMode = mode;

  if (synth) synth.dispose();

  if (mode === "calm") {
    synth = new Tone.PolySynth(Tone.Synth, {
      volume: 0,
      oscillator: { type: "triangle" },
      envelope: {
        attack: 0.005,
        decay: 0.1,
        sustain: 0.3,
        release: 1,
      },
    }).toDestination();
  }

  if (mode === "active") {
    synth = new Tone.FMSynth({
      volume: 0,
      harmonicity: 3,
      modulationIndex: 12.22,
      envelope: {
        attack: 0.01,
        decay: 0.2,
        sustain: 1,
        release: 0.5,
      },
      modulation: { type: "square" },
      modulationEnvelope: {
        attack: 0.2,
        decay: 0.01,
        sustain: 1,
        release: 0.5,
      },
    }).toDestination();
  }

  if (mode === "energetic") {
    synth = new Tone.PolySynth(Tone.MonoSynth, {
      volume: -8,
      oscillator: { type: "square8" },
      filter: {
        type: "lowpass",
        rolloff: -12,
        Q: 1,
      },
      envelope: {
        attack: 0.05,
        decay: 0.3,
        sustain: 0.4,
        release: 0.8,
      },
      filterEnvelope: {
        attack: 0.001,
        decay: 0.7,
        sustain: 0.1,
        release: 0.8,
        baseFrequency: 300,
        octaves: 4,
      },
    }).toDestination();
  }

  document.getElementById("mode").innerText = "Mode: " + mode;
}

/* ===============================
   iOS 13+ permission
================================ */
async function startMotion() {
  await Tone.start();

  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    const permission = await DeviceMotionEvent.requestPermission();
    if (permission !== "granted") {
      alert("Motion permission denied");
      return;
    }
  }

  window.addEventListener("devicemotion", e => {
    const a = e.accelerationIncludingGravity;
    if (!a) return;

    const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
    accelHistory.push(mag);
    if (accelHistory.length > WINDOW_SIZE) accelHistory.shift();
  });

  Tone.Transport.start();
  loop.start(0);

  updateLoop();
}

/* ===============================
   更新ループ
================================ */
function updateLoop() {
  const activity = getActivity();
  const bpm = activityToBPM(activity);

  Tone.Transport.bpm.rampTo(bpm, 0.5);
  setSynthByBPM(bpm);

  document.getElementById("activity").innerText =
    "Activity: " + activity.toFixed(2);
  document.getElementById("bpm").innerText =
    "BPM: " + bpm.toFixed(1);

  requestAnimationFrame(updateLoop);
}

document.getElementById("startBtn").addEventListener("click", startMotion);
</script>
</body>
</html>
