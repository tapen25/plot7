<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nature to Speed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a24; color: #fff; text-align: center; padding: 20px; overflow: hidden; user-select: none; }
        
        #playBtn {
            margin-top: 35vh;
            padding: 20px 60px; font-size: 1.2rem; font-weight: bold;
            color: #fff; background: linear-gradient(135deg, #20c997, #0077ff);
            border: none; border-radius: 50px;
            box-shadow: 0 0 20px rgba(32, 201, 151, 0.5); transition: transform 0.1s;
        }
        #playBtn:active { transform: scale(0.95); }

        .hud { position: absolute; top: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 10; pointer-events: none;}
        .status-label { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .sub-label { font-size: 0.9rem; color: #aaa; font-family: monospace; }

        /* 背景の変化 */
        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA); /* 空色（初期） */
            opacity: 0.8; transition: background 1s;
        }
        
        /* 鳥のビジュアライザ */
        .bird-visual {
            position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="hud">
        <div class="status-label" id="statusText">WALK</div>
        <div class="sub-label">SPEED: <span id="speedVal">0%</span></div>
    </div>

    <button id="playBtn">START JOURNEY</button>

<script>
// ==========================================
// 1. システム設定
// ==========================================
let isPlaying = false;
let smoothedActivity = 0.0;
const BUFFER_SIZE = 10;
const motionBuffer = [];

// ==========================================
// 2. 音楽理論データ (Key: C Major)
// ==========================================
const chords = [
    { name: "FM7", notes: ["F3", "A3", "C4", "E4"] },
    { name: "G7",  notes: ["G3", "B3", "D4", "F4"] },
    { name: "Em7", notes: ["E3", "G3", "B3", "D4"] },
    { name: "Am7", notes: ["A3", "C4", "E4", "G4"] } 
];

// 高速アルペジオ用 (高音域)
const arpeggioNotes = [
    ["F4", "A4", "C5", "E5", "F5", "A5"], 
    ["G4", "B4", "D5", "F5", "G5", "B5"], 
    ["E4", "G4", "B4", "D5", "E5", "G5"], 
    ["A4", "C5", "E5", "G5", "A5", "C6"]  
];

// ==========================================
// 3. 音源セットアップ
// ==========================================
let leadSynth, chordSynth, bassSynth, drumKit;
let windNode, windGain, windFilter;
let birdSynth, birdPan;

function setupAudio() {
    const limiter = new Tone.Limiter(-0.5).toDestination();
    const reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).connect(limiter); // 全体にリバーブをかけて空間演出

    // A. 楽器類
    leadSynth = new Tone.Synth({
        oscillator: { type: "triangle" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 },
        volume: -6
    }).connect(reverb);

    chordSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" }, // 優しい音
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 },
        volume: -10
    }).connect(reverb);

    bassSynth = new Tone.FMSynth({
        harmonicity: 1, modulationIndex: 2,
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.8, release: 0.5 },
        volume: -6
    }).connect(limiter); // ベースはリバーブ少なめorなし

    drumKit = {
        kick: new Tone.MembraneSynth({ volume: -4 }).connect(limiter),
        hat: new Tone.MetalSynth({ frequency: 200, envelope: { decay: 0.05 }, volume: -22 }).connect(limiter)
    };

    // B. 風 (控えめ設定)
    windFilter = new Tone.Filter({ type: "bandpass", frequency: 200, Q: 0.5 });
    windGain = new Tone.Gain(0).connect(limiter);
    windNode = new Tone.Noise("pink").connect(windFilter).connect(windGain);
    windNode.start();

    // C. 鳥 (合成音)
    // 左右に振るためのPanner
    birdPan = new Tone.Panner(0).connect(reverb);
    
    // 鳥の鳴き声用シンセ
    // 周波数がスライドするエンベロープを使う
    birdSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }, // 非常に短い音
        volume: -12
    }).connect(birdPan);
}

// ==========================================
// 4. 鳥の生成ロジック
// ==========================================
function triggerBird() {
    // ランダムに左右に振る (-1.0 ~ 1.0)
    birdPan.pan.value = (Math.random() * 2) - 1;
    
    // 鳥っぽい高音 (C6 ~ C7周辺)
    // 少しピッチを揺らすとリアルになるが、ここではシンプルに高音短音
    const freq = 1000 + Math.random() * 2000; // 1000Hz - 3000Hz
    
    // 2回鳴く (チュンチュン) か 1回鳴く (ピヨ)
    const now = Tone.now();
    
    birdSynth.triggerAttackRelease(freq, "32n", now);
    // スライド効果(Frequency Envelopeの代わり)
    birdSynth.frequency.rampTo(freq + 500, 0.05, now);

    if (Math.random() > 0.5) {
        birdSynth.triggerAttackRelease(freq + 200, "32n", now + 0.1);
    }

    // 視覚演出
    showBirdVisual();
}

function showBirdVisual() {
    const el = document.createElement('div');
    el.className = 'bird-visual';
    el.style.left = (Math.random() * 80 + 10) + '%';
    el.style.top = (Math.random() * 60 + 10) + '%';
    document.body.appendChild(el);
    
    // アニメーション
    setTimeout(() => { el.style.opacity = 1; }, 10);
    setTimeout(() => { el.style.opacity = 0; }, 500);
    setTimeout(() => { el.remove(); }, 1000);
}

// ==========================================
// 5. シーケンサー
// ==========================================
let tick = 0;

function startLoop() {
    Tone.Transport.bpm.value = 100;

    Tone.Transport.scheduleRepeat((time) => {
        const intensity = smoothedActivity; 
        
        const beat16 = tick % 16;
        const barIndex = Math.floor(tick / 16) % 4;
        const currentChord = chords[barIndex];

        // --- 1. 鳥 (Low Activityのみ) ---
        if (intensity < 0.3) {
            // 確率で鳴く (たまに)
            if (Math.random() < 0.05) { // 5%の確率で毎16分音符ごとに判定
                triggerBird();
            }
        }

        // --- 2. コード (常に) ---
        if (beat16 === 0) {
            chordSynth.triggerAttackRelease(currentChord.notes, "2n", time);
        }

        // --- 3. ベース & ドラム ---
        // intensityで音数が増える
        if (beat16 === 0) {
             const root = currentChord.notes[0].replace("3","2").replace("4","3");
             bassSynth.triggerAttackRelease(root, "8n", time);
             drumKit.kick.triggerAttackRelease("C1", "8n", time);
        }
        
        if (intensity > 0.5) {
            // 走り出すとベースとハイハットが増える
            if (beat16 === 10) {
                const root = currentChord.notes[0].replace("3","2").replace("4","3");
                bassSynth.triggerAttackRelease(root, "8n", time);
            }
            if (beat16 % 4 === 0) drumKit.hat.triggerAttackRelease("32n", time);
        }
        
        if (intensity > 0.8) {
            // 暴走モード: ドラム連打
            drumKit.hat.triggerAttackRelease("32n", time);
        }

        // --- 4. メロディ (理論的アルペジオ) ---
        playMelody(time, intensity, beat16, barIndex);

        tick++;
    }, "16n");

    Tone.Transport.start();
}

function playMelody(time, act, beat, chordIdx) {
    // 静止時(Birdsフェーズ)はメロディを極力減らす（環境音メイン）
    if (act < 0.3) {
        // 小節の頭だけ優しく鳴らす
        if (beat === 0 && Math.random() > 0.5) {
            leadSynth.triggerAttackRelease(chords[chordIdx].notes[2], "4n", time);
        }
        return;
    }
    
    // アルペジオモード (Activity高)
    if (act > 0.6) {
        // 音数制御: Activityが高いほど隙間なく埋める
        const density = act > 0.8 ? 1 : 2; // 0.8超えなら全部、それ以外は2つおき
        if (tick % density === 0) {
            const arpNotes = arpeggioNotes[chordIdx];
            const noteIndex = tick % arpNotes.length; 
            leadSynth.triggerAttackRelease(arpNotes[noteIndex], "16n", time);
        }
    } 
    // 中間モード (ランダムなコードトーン)
    else {
        if (beat % 2 === 0 && Math.random() < 0.5) {
            const notes = chords[chordIdx].notes;
            const note = notes[Math.floor(Math.random() * notes.length)];
            leadSynth.triggerAttackRelease(note, "8n", time);
        }
    }
}

// ==========================================
// 6. 更新ループ (風 & 背景)
// ==========================================
function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    smoothedActivity += ((motionBuffer.length ? motionBuffer[motionBuffer.length-1] : 0) - smoothedActivity) * 0.05;
    smoothedActivity = Math.max(0, Math.min(1, smoothedActivity));

    // --- 風制御 (控えめ) ---
    // Gain: 0.0 -> 0.15 (以前の0.8から大幅減)
    // 動き始め(0.3)までは無音
    let windVol = Math.max(0, (smoothedActivity - 0.2) * 0.25); 
    windGain.gain.rampTo(windVol, 0.1);

    const windFreq = 200 + (smoothedActivity * 1000); // フィルターも穏やかに
    windFilter.frequency.rampTo(windFreq, 0.1);

    // --- 背景色制御 ---
    const bg = document.getElementById('bg-layer');
    const statusText = document.getElementById('statusText');
    const speedVal = document.getElementById('speedVal');

    speedVal.innerText = Math.round(smoothedActivity * 100) + "%";

    // BPM制御
    Tone.Transport.bpm.rampTo(100 + (smoothedActivity * 40), 0.1);

    if (smoothedActivity < 0.3) {
        // 空色 (鳥タイム)
        bg.style.background = "linear-gradient(to bottom, #87CEEB, #E0F7FA)";
        statusText.innerText = "NATURE WALK";
        statusText.style.color = "#fff";
    } else if (smoothedActivity < 0.7) {
        // 夕暮れ/少し紫 (ランニング)
        bg.style.background = "linear-gradient(to bottom, #6a11cb, #2575fc)";
        statusText.innerText = "RUNNING";
        statusText.style.color = "#ffeb3b";
    } else {
        // 宇宙/赤黒 (疾走)
        bg.style.background = "linear-gradient(to bottom, #44000b, #000)";
        statusText.innerText = "GALAXY DASH";
        statusText.style.color = "#ff0055";
    }
}

// ==========================================
// 7. センサー入力
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    const x = a.x || 0; const y = a.y || 0; const z = a.z || 0;
    const mag = Math.sqrt(x*x + y*y + z*z);
    const shake = Math.abs(mag - 9.8); 
    const normalized = Math.min(shake / 5.0, 1.0);
    motionBuffer.push(normalized);
    if(motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
}

document.getElementById('playBtn').addEventListener('click', async () => {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const state = await DeviceMotionEvent.requestPermission();
        if (state !== 'granted') return alert("センサー許可が必要です");
    }
    window.addEventListener('devicemotion', handleMotion);
    await Tone.start();
    setupAudio();
    startLoop();
    isPlaying = true;
    update();
    document.getElementById('playBtn').style.display = 'none';
});
</script>
</body>
</html>