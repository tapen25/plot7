<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Orchestra</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a2e; color: #fff; text-align: center; padding: 20px; }
        #startBtn { padding: 20px 40px; font-size: 1.2rem; background: #e94560; border: none; color: #fff; border-radius: 8px; cursor: pointer; margin-top: 50px; }
        #status { margin-top: 30px; font-size: 1.5rem; line-height: 1.8; }
        .data { font-family: monospace; color: #0f3460; background: #fff; padding: 2px 5px; border-radius: 4px;}
        .inst-status { font-size: 1.2rem; font-weight: bold; margin-top: 15px; height: 1.5em; text-shadow: 0 0 10px rgba(255,255,255,0.5);}
    </style>
</head>
<body>

    <h1>Motion Orchestra</h1>
    <p>ã‚¹ãƒãƒ›ã‚’ã‚†ã£ãã‚Šå‹•ã‹ã™ã¨ãƒã‚¤ã‚ªãƒªãƒ³ã€<br>æ¿€ã—ãæŒ¯ã‚‹ã¨ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆãŒé³´ã‚Šã¾ã™ã€‚</p>
    <button id="startBtn">ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã‚’é–‹å§‹</button>
    
    <div id="status">
        <div id="soundDesc" class="inst-status">Ready...</div>
        <div>Intensity: <span id="actVal" class="data">0.00</span></div>
        <div>BPM: <span id="bpmVal" class="data">90</span></div>
        <div style="font-size: 0.8rem; color: #aaa; margin-top:20px;">Sensor: <span id="sensorState">å¾…æ©Ÿä¸­</span></div>
    </div>

<script>
// ==========================================
// 1. è¨­å®š
// ==========================================
const DURATION = 2000; 
const motionBuffer = []; 
let targetActivity = 0.0; 
let activity = 0.0;       
let smoothedVariance = 0.0; 
let tickCounter = 0;      
let prevNote = "C4";      
let motionListenerAttached = false;

// ==========================================
// 2. éŸ³æ¥½ãƒ‡ãƒ¼ã‚¿
// ==========================================
const chords = [
  ["C3","E3","G3"], ["B2","D3","G3"], ["A2","C3","E3"], ["G2","B2","E3"],
  ["F2","A2","C3"], ["E2","G2","C3"], ["F2","A2","C3"], ["G2","B2","D3"]
];
// ãƒ¡ãƒ­ãƒ‡ã‚£ç”¨ã‚¹ã‚±ãƒ¼ãƒ«
const scales = [
  ["C4","D4","E4","G4","A4"], ["G3","A3","B3","D4","E4"], ["A3","C4","D4","E4","G4"], ["E3","G3","A3","B3","D4"],
  ["F3","G3","A3","C4","D4"], ["C4","D4","E4","G4","A4"], ["F3","G3","A3","C4","D4"], ["G3","A3","B3","D4","E4"]
];

// ==========================================
// 3. æ¥½å™¨è¨­å®š (ã“ã“ã‚’å¤‰æ›´)
// ==========================================
let chordSynth, stringSynth, brassSynth;
let kick, snare, hihat;
let reverb, delay;

function setupSynths() {
    // ç©ºé–“ç³»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã£ã½ã„éŸ¿ãï¼‰
    reverb = new Tone.Reverb({ decay: 4, wet: 0.4 }).toDestination();
    delay = new Tone.FeedbackDelay("8n", 0.2).connect(reverb);

    // --- èƒŒæ™¯ã‚³ãƒ¼ãƒ‰ (ãƒ”ã‚¢ãƒé¢¨) ---
    chordSynth = new Tone.PolySynth(Tone.Synth, {
        volume: -12,
        oscillator: { type: "triangle" }, // å„ªã—ã„éŸ³
        envelope: { attack: 0.05, decay: 0.5, sustain: 0.5, release: 1 }
    }).connect(reverb);

    // --- é™: ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹/ãƒã‚¤ã‚ªãƒªãƒ³é¢¨ã‚·ãƒ³ã‚» ---
    // ã‚¢ã‚¿ãƒƒã‚¯ã‚’é…ãã—ã¦ã€FMåˆæˆã§è±Šã‹ãªå€éŸ³ã‚’ä½œã‚‹
    stringSynth = new Tone.PolySynth(Tone.FMSynth, {
        volume: -8,
        harmonicity: 3.01, // å€éŸ³æ§‹æˆ
        modulationIndex: 14,
        oscillator: { type: "triangle" },
        envelope: { attack: 0.4, decay: 0.8, sustain: 0.8, release: 1.5 }, // ãµã‚ã£ã¨å…¥ã‚‹
        modulation: { type: "square" },
        modulationEnvelope: { attack: 0.4, decay: 0.2, sustain: 0.2, release: 0.5 }
    });
    // ãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆã‚’ã‹ã‘ã‚‹
    const vibrato = new Tone.Vibrato(5, 0.1).connect(reverb);
    stringSynth.connect(vibrato);


    // --- å‹•: ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ/ãƒ–ãƒ©ã‚¹é¢¨ã‚·ãƒ³ã‚» ---
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã§ã€Œãƒ—ãƒ¯ãƒƒã€ã¨ã„ã†å¹å¥æ„Ÿã‚’å‡ºã™
    brassSynth = new Tone.MonoSynth({
        volume: -100, // åˆæœŸå€¤ã¯ãƒŸãƒ¥ãƒ¼ãƒˆ
        oscillator: { type: "sawtooth" }, // ãƒã‚³ã‚®ãƒªæ³¢ã¯é‡‘ç®¡ã«è¿‘ã„
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 0.2 }, // æ­¯åˆ‡ã‚Œã‚ˆã
        filterEnvelope: { 
            attack: 0.06, // å°‘ã—é…ã‚Œã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé–‹ãï¼ãƒ–ãƒ©ã‚¹ç‰¹æœ‰ã®ã‚¢ã‚¿ãƒƒã‚¯æ„Ÿ
            decay: 0.2, 
            sustain: 0.3, 
            baseFrequency: 300, 
            octaves: 3, 
            exponent: 2 
        }
    }).connect(delay); // ãƒ‡ã‚£ãƒ¬ã‚¤ã‚’ã‹ã‘ã¦æ´¾æ‰‹ã«ã™ã‚‹

    // --- ãƒ‰ãƒ©ãƒ  ---
    kick = new Tone.MembraneSynth({ volume: -6 }).toDestination();
    snare = new Tone.NoiseSynth({ volume: -15, envelope: { decay: 0.2 } }).toDestination();
    hihat = new Tone.MetalSynth({ volume: -20, frequency: 200, envelope: { decay: 0.05 }, harmonicity: 5.1 }).toDestination();
}

// ==========================================
// 4. æ¼”å¥ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================
function nextNote(prev, candidates) {
    // æ¿€ã—ã„æ™‚ã¯éŸ³ç¨‹ã®è·³èºã‚’å¤§ããã™ã‚‹
    const bias = 1 + activity * 12;
    let best = candidates[0];
    let bestScore = 999;
    for (const n of candidates) {
        const midiPrev = Tone.Frequency(prev).toMidi();
        const midiN = Tone.Frequency(n).toMidi();
        const score = Math.abs(Math.abs(midiN - midiPrev) - bias);
        if (score < bestScore) {
            bestScore = score;
            best = n;
        }
    }
    return best;
}

function startMusicLoop() {
    Tone.Transport.bpm.value = 90;

    // --- ã‚³ãƒ¼ãƒ‰é€²è¡Œ ---
    Tone.Transport.scheduleRepeat((time) => {
        const bar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
        chordSynth.triggerAttackRelease(chords[bar], "1n", time);
    }, "1n");

    // --- ãƒ¡ãƒ­ãƒ‡ã‚£ ---
    Tone.Transport.scheduleRepeat((time) => {
        // æ¿€ã—ã•ã§ãƒªã‚ºãƒ ã‚’å¤‰ãˆã‚‹
        let step = (activity < 0.4) ? 4 : (activity > 0.8 ? 1 : 2); 
        const duration = (step >= 4) ? "2n" : "8n"; // é™ã‹ãªæ™‚ã¯é•·ãã€æ¿€ã—ã„æ™‚ã¯çŸ­ã
        const probability = (activity > 0.7) ? 0.9 : 0.7;

        if (tickCounter % step === 0) {
             if (Math.random() < probability) {
                const currentBar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
                const next = nextNote(prevNote, scales[currentBar]);
                
                // ä¸¡æ–¹ã®ã‚·ãƒ³ã‚»ã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼ˆéŸ³é‡ã¯updateLoopã§ç®¡ç†ï¼‰
                // ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ã¯é«˜ã„éŸ³ã«ãªã‚Šã™ããªã„ã‚ˆã†ã«å°‘ã—ä¸‹ã’ã‚‹åˆ¶å¾¡ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ãŒä»Šå›ã¯ãã®ã¾ã¾
                stringSynth.triggerAttackRelease(next, duration, time);
                
                // ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆã¯å°‘ã—ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’ä¸Šã’ãŸã‚Šç›®ç«‹ãŸã›ã‚‹
                brassSynth.triggerAttackRelease(next, duration, time);
                
                prevNote = next;
            }
        }
        tickCounter++;
    }, "16n");

    // --- ãƒ‰ãƒ©ãƒ  ---
    Tone.Transport.scheduleRepeat((time) => {
        const s = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
        let k = false, n = false, h = false;

        // activityã«å¿œã˜ã¦ãƒ‰ãƒ©ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ã£ã½ãå¤‰åŒ–
        if (activity < 0.3) {
            // ãƒ†ã‚£ãƒ³ãƒ‘ãƒ‹çš„ãªã‚­ãƒƒã‚¯ã®ã¿
            if (s % 16 === 0) k = true;
        } else if (activity < 0.7) {
            // è¡Œé€²æ›²é¢¨
            if (s % 4 === 0) k = true;
            if (s % 4 === 2) n = true; // å°å¤ªé¼“
        } else {
            // æ¿€ã—ã„ãƒªã‚ºãƒ 
            if (s % 2 === 0) k = true;
            if (s % 4 === 2) n = true;
            h = true; // ã‚·ãƒ³ãƒãƒ«é€£æ‰“
        }
        
        if (k) kick.triggerAttackRelease("C1", "8n", time);
        if (n) snare.triggerAttackRelease("8n", time);
        if (h) hihat.triggerAttackRelease("32n", time);
    }, "16n");

    Tone.Transport.start();
}

// ==========================================
// 5. ã‚»ãƒ³ã‚µãƒ¼ & ãƒ«ãƒ¼ãƒ—å‡¦ç†
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    const mag = Math.sqrt(a.x * a.x + a.y * a.y + a.z * a.z);
    const now = Date.now();
    motionBuffer.push({ t: now, m: mag });
    while (motionBuffer.length > 0 && motionBuffer[0].t < now - DURATION) {
        motionBuffer.shift();
    }
    if (motionBuffer.length < 10) { targetActivity = 0.0; return; }
    
    // æ¨™æº–åå·®è¨ˆç®—
    const magnitudes = motionBuffer.map(d => d.m);
    const mean = magnitudes.reduce((s, v) => s + v, 0) / magnitudes.length;
    const variance = magnitudes.reduce((s, v) => s + (v - mean) ** 2, 0) / magnitudes.length;
    const stdDev = Math.sqrt(variance); 
    
    // æ­£è¦åŒ– (0.0 - 1.0)
    targetActivity = Math.min(stdDev / 8.0, 1.0);
    smoothedVariance = smoothedVariance * 0.9 + stdDev * 0.1; 
}

function updateLoop() {
    // å€¤ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹
    activity += (targetActivity - activity) * 0.05;
    document.getElementById('actVal').innerText = activity.toFixed(2);
    
    // BPMå¤‰åŒ– (ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ©ãªã®ã§å¤§èƒ†ã«å¤‰ãˆã‚‹)
    // é™:60(Adagio) ã€œ å‹•:140(Allegro)
    let targetBpm = 70 + (smoothedVariance * 12);
    Tone.Transport.bpm.rampTo(targetBpm, 0.5); 
    document.getElementById('bpmVal').innerText = Math.round(Tone.Transport.bpm.value);

    // =========================================
    // â˜… æ¥½å™¨ã®ãƒãƒ©ãƒ³ã‚¹åˆ¶å¾¡ (ãƒŸã‚­ã‚·ãƒ³ã‚°)
    // =========================================
    if (stringSynth && brassSynth) {
        
        // 1. ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ (Violin)
        // å¸¸ã«é³´ã£ã¦ã„ã‚‹ãŒã€æ¿€ã—ã„ã¨ãã¯ãƒ–ãƒ©ã‚¹ã«ä¸»å½¹ã‚’è­²ã‚‹ãŸã‚ã«å°‘ã—ä¸‹ã’ã‚‹
        // é™(-8dB) -> æ¿€(-15dB)
        const strVol = -8 - (activity * 12);
        stringSynth.volume.rampTo(strVol, 0.1);

        // 2. ãƒ–ãƒ©ã‚¹ (Trumpet)
        // é™ã‹ãªã¨ãã¯ãƒŸãƒ¥ãƒ¼ãƒˆã€activity 0.3ãã‚‰ã„ã‹ã‚‰ç™»å ´
        let brassVol = -100;
        if (activity > 0.3) {
            // æ€¥æ¿€ã«éŸ³é‡ã‚’ä¸Šã’ã¦ç›®ç«‹ãŸã›ã‚‹
            brassVol = -20 + ((activity - 0.3) / 0.7) * 20; // Max 0dB
        }
        brassSynth.volume.rampTo(brassVol, 0.1);

        // 3. UIè¡¨ç¤ºæ›´æ–°
        const descEl = document.getElementById('soundDesc');
        if (activity < 0.3) {
            descEl.innerText = "ğŸ» Strings / Adagio";
            descEl.style.color = "#4fd1c5";
        } else if (activity < 0.7) {
            descEl.innerText = "ğŸº Ensemble / Moderato";
            descEl.style.color = "#f6ad55";
        } else {
            descEl.innerText = "ğŸ”¥ Brass Tutti / Allegro";
            descEl.style.color = "#fc8181";
        }
    }

    requestAnimationFrame(updateLoop);
}

// ==========================================
// 6. é–‹å§‹å‡¦ç†
// ==========================================
const btn = document.getElementById('startBtn');
const sensorState = document.getElementById('sensorState');

btn.addEventListener('click', async () => {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const permissionState = await DeviceMotionEvent.requestPermission();
            if (permissionState === 'granted') {
                window.addEventListener('devicemotion', handleMotion);
                motionListenerAttached = true;
                sensorState.innerText = "ã‚»ãƒ³ã‚µãƒ¼OK (iOS)";
            } else { alert("è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }
        } catch (e) { alert(e); return; }
    } else {
        window.addEventListener('devicemotion', handleMotion);
        motionListenerAttached = true;
        sensorState.innerText = "ã‚»ãƒ³ã‚µãƒ¼OK (Android)";
    }

    await Tone.start();
    setupSynths();

    if (motionListenerAttached) {
        btn.innerText = "æ¼”å¥ä¸­...";
        btn.disabled = true;
        startMusicLoop();
        updateLoop();
    }
});
</script>
</body>
</html>