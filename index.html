<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Music V5 - Strings Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
            color: #fff; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
        }
        h1 { font-weight: 200; letter-spacing: 0.1em; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        p { font-size: 1rem; opacity: 0.9; }
        
        #startBtn { 
            padding: 20px 50px; font-size: 1.2rem; 
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); 
            border-radius: 50px; color: #fff; cursor: pointer; 
            margin-top: 30px; backdrop-filter: blur(5px);
            transition: background 0.3s;
        }
        #startBtn:hover { background: rgba(255,255,255,0.4); }

        #status { 
            margin-top: 40px; 
            background: rgba(0,0,0,0.2); 
            padding: 25px; 
            border-radius: 20px; 
            display: inline-block; 
            min-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .data { font-weight: bold; font-size: 1.8rem; }
        .label { font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        
        #mode-display {
            margin-top: 15px; font-size: 1.2rem; font-weight: bold;
            padding: 5px 15px; border-radius: 10px; background: rgba(255,255,255,0.2); display: inline-block;
        }

        #wind-indicator {
            height: 6px; background: rgba(255,255,255,0.3); width: 220px; margin: 15px auto 5px; border-radius: 3px; overflow: hidden;
        }
        #wind-bar {
            height: 100%; width: 0%; background: #fff; transition: width 0.05s;
        }
    </style>
</head>
<body>

<h1>Motion Music V5</h1>
<p>Strings Strings & Story</p>

<button id="startBtn">TAP TO START</button>

<div id="status">
    <div class="label">BPM (Speed)</div>
    <div id="bpmVal" class="data">100</div>
    
    <div style="margin-top:20px;" class="label">Wind Intensity</div>
    <div id="wind-indicator"><div id="wind-bar"></div></div>

    <div style="margin-top:20px;" class="label">Story Mode</div>
    <div id="mode-display">Calm Strings</div>
</div>

<script>
// ============================================================
// 1. 設定・状態変数
// ============================================================
const BUFFER_SIZE = 20;
const motionBuffer = [];
let instantMotion = 0; 
let smoothedMotion = 0; 
let isPlaying = false;

// ============================================================
// 2. コード進行定義 (ストーリー分岐)
// ============================================================
// ストリングスに合わせて音域を少し調整
const chordsCalm = [
  ["C4","E4","G4","B4"], 
  ["A3","C4","E4","G4"], 
  ["F3","A3","C4","E4"], 
  ["G3","B3","D4","F4"]
];

const chordsActive = [
  ["D4","F4","A4","C5"], 
  ["E4","G4","B4","D5"], 
  ["F4","A4","C5","E5"], 
  ["G4","C5","D5","F5"] 
];

// ============================================================
// 3. シンセ・音源設定
// ============================================================
let chordSynth, bassSynth, melodySynth;
let kick, shaker;
let windSynth, windFilter;
let chorus, reverb, delay;

function setupSynths() {
    // --- エフェクト (ストリングス用に広がりを強化) ---
    reverb = new Tone.Reverb({ decay: 6, wet: 0.5 }).toDestination(); // 深めのリバーブ
    chorus = new Tone.Chorus(2.5, 4.0, 0.6).connect(reverb).start(); // 厚みを出すコーラス
    delay  = new Tone.FeedbackDelay("8n.", 0.2).connect(reverb);

    // --- 1. Chords (Strings Section) ★ここを変更 ---
    // fatsawtooth: 複数のノコギリ波を重ねてデチューンした音（ストリングスの定番）
    chordSynth = new Tone.PolySynth(Tone.Synth, {
        volume: -12,
        oscillator: {
            type: "fatsawtooth",
            count: 3,
            spread: 30
        },
        envelope: {
            attack: 0.6,  // ゆっくり立ち上がる（ボウイングの表現）
            decay: 0.1,
            sustain: 1.0, // 鍵盤を押している間は音が減衰しない
            release: 2.0  // 指を離した後も長く響く
        }
    }).connect(chorus); // コーラスに通してさらに広げる

    // --- 2. Melody (Harp/Pluck style) ---
    melodySynth = new Tone.PolySynth(Tone.Synth, {
        volume: -8,
        oscillator: { type: "triangle" },
        envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 1.5 }
    }).connect(delay);

    // --- 3. Bass (Cello/Contrabass style) ---
    bassSynth = new Tone.MonoSynth({
        volume: -6,
        oscillator: { type: "sawtooth" },
        filter: { type: "lowpass", frequency: 300 }, // 高域を削って低音弦っぽく
        envelope: { attack: 0.3, decay: 0.3, sustain: 0.8, release: 1.5 }
    }).connect(reverb);

    // --- 4. Drums ---
    kick = new Tone.MembraneSynth({ volume: -6 }).toDestination();
    shaker = new Tone.NoiseSynth({ volume: -22, envelope: { decay: 0.1 } }).connect(reverb);

    // --- 5. Wind ---
    windFilter = new Tone.Filter({ type: "highpass", frequency: 500, Q: 0.5 }).toDestination();
    windSynth = new Tone.NoiseSynth({
        volume: -100,
        noise: { type: "white" },
        envelope: { attack: 0.5, decay: 0.1, sustain: 1, release: 0.5 }
    }).connect(windFilter);
}

// ============================================================
// 4. ミュージックループ
// ============================================================
function startMusicLoop() {
    Tone.Transport.bpm.value = 100;
    windSynth.triggerAttack(); 

    // --- コード演奏 ---
    Tone.Transport.scheduleRepeat((time) => {
        const bar = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ * 4)) % 4;
        
        // ストーリー分岐
        const isHighEnergy = smoothedMotion > 0.6;
        const currentProgression = isHighEnergy ? chordsActive : chordsCalm;
        
        const chord = currentProgression[bar];
        chordSynth.releaseAll();
        chordSynth.triggerAttackRelease(chord, "1n", time);

        // ベース
        const root = chord[0];
        // Bassをオクターブ下で
        bassSynth.triggerAttackRelease(Tone.Frequency(root).transpose(-12), "1n", time);

    }, "1n");

    // --- メロディ ---
    Tone.Transport.scheduleRepeat((time) => {
        if (Math.random() < 0.4 + (smoothedMotion * 0.4)) {
            const notes = ["C5","D5","E5","G5","A5","B5"];
            const note = notes[Math.floor(Math.random() * notes.length)];
            melodySynth.triggerAttackRelease(note, "16n", time);
        }
    }, "8n");

    // --- リズム ---
    Tone.Transport.scheduleRepeat((time) => {
        const beat = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
        if (beat % 4 === 0) kick.triggerAttackRelease("C2", "8n", time);
        
        if (smoothedMotion > 0.3) {
            if (beat % 2 === 0) shaker.triggerAttackRelease("32n", time);
        }
        if (smoothedMotion > 0.7 && beat % 2 !== 0) {
            shaker.triggerAttackRelease("32n", time, 0.5); 
        }
    }, "16n");

    Tone.Transport.start();
}

// ============================================================
// 5. センサー処理
// ============================================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;

    const x = a.x || 0;
    const y = a.y || 0;
    const z = a.z || 0;
    const mag = Math.sqrt(x*x + y*y + z*z);

    motionBuffer.push(mag);
    if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();

    if (motionBuffer.length < 5) return;

    const mean = motionBuffer.reduce((s,v)=>s+v,0) / motionBuffer.length;
    const variance = motionBuffer.reduce((s,v)=>s+(v-mean)**2,0) / motionBuffer.length;
    const stdDev = Math.sqrt(variance);

    let rawActivity = Math.min(stdDev / 4.0, 1.0);
    instantMotion = rawActivity;
    smoothedMotion = smoothedMotion * 0.9 + instantMotion * 0.1;
}

// ============================================================
// 6. 描画ループ
// ============================================================
function updateLoop() {
    if (!isPlaying) return;

    // BPM: 100 ~ 150
    const minBpm = 100;
    const maxBpm = 150;
    let targetBpm = minBpm + (smoothedMotion * (maxBpm - minBpm));
    Tone.Transport.bpm.rampTo(targetBpm, 0.2);

    // Wind Volume
    let windVol = -60 + (instantMotion * 50);
    if (instantMotion < 0.05) windVol = -100;
    windSynth.volume.rampTo(windVol, 0.1);
    
    // Wind Filter
    let windFreq = 500 + (instantMotion * 4000);
    windFilter.frequency.rampTo(windFreq, 0.1);

    // UI
    document.getElementById("bpmVal").textContent = Math.round(Tone.Transport.bpm.value);
    
    const modeDiv = document.getElementById("mode-display");
    if (smoothedMotion > 0.6) {
        modeDiv.textContent = "Dramatic (Active)";
        modeDiv.style.color = "#ffdddd";
    } else {
        modeDiv.textContent = "Calm Strings";
        modeDiv.style.color = "#fff";
    }

    const wPercent = Math.min(100, instantMotion * 100);
    document.getElementById("wind-bar").style.width = wPercent + "%";

    requestAnimationFrame(updateLoop);
}

// ============================================================
// 7. スタート処理
// ============================================================
document.getElementById("startBtn").addEventListener("click", async () => {
    if (isPlaying) return;
    if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        try {
            const res = await DeviceMotionEvent.requestPermission();
            if (res !== "granted") {
                alert("センサー不可");
                return;
            }
        } catch (e) { console.error(e); }
    }
    window.addEventListener("devicemotion", handleMotion);

    await Tone.start();
    setupSynths();
    
    isPlaying = true;
    startMusicLoop();
    updateLoop();

    document.getElementById("startBtn").style.display = "none";
});
</script>
</body>
</html>