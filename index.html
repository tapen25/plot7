<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circular Progression & Dynamic Melody</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #0d0d15; color: #fff; text-align: center; padding: 20px; overflow: hidden; user-select: none; }
        h1 { font-size: 1.2rem; color: #00d1b2; letter-spacing: 2px; }
        
        #playBtn {
            margin-top: 40vh;
            padding: 20px 50px; font-size: 1.5rem; font-weight: bold;
            color: #fff; background: #ff0055; border: none; border-radius: 50px;
            box-shadow: 0 0 15px #ff0055; transition: transform 0.1s;
        }
        #playBtn:active { transform: scale(0.95); }

        /* ビジュアライザー */
        .bar-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: flex-end; justify-content: space-around;
            z-index: -1; pointer-events: none; opacity: 0.5;
        }
        .bar { width: 10%; background: linear-gradient(to top, #00d1b2, transparent); transition: height 0.1s; }

        .info { position: absolute; top: 60px; width: 100%; text-align: center; font-family: monospace; }
        .level-text { font-size: 2rem; font-weight: bold; text-shadow: 0 0 10px white; }
    </style>
</head>
<body>

    <h1>Run & Roll Music</h1>
    <div class="info">
        <div>Activity: <span id="actVal">0%</span></div>
        <div class="level-text" id="lvlText">STOP</div>
    </div>

    <button id="playBtn">TAP TO START</button>

    <div class="bar-container">
        <div class="bar" id="b1"></div><div class="bar" id="b2"></div>
        <div class="bar" id="b3"></div><div class="bar" id="b4"></div>
    </div>

<script>
// ==========================================
// 1. グローバル設定
// ==========================================
let isPlaying = false;
let activity = 0.0;       // 現在の活動量 (0.0 - 1.0)
let smoothedActivity = 0.0;
const BUFFER_SIZE = 10;
const motionBuffer = [];

// ==========================================
// 2. 音楽理論データ (Key: C Major / Am)
// ==========================================

// 王道進行 (IV - V - iii - vi) => FM7 - G7 - Em7 - Am7
// ずっとループできる「終わらない感」がある進行
const chordProgression = [
    ["F3", "A3", "C4", "E4"], // FMaj7
    ["G3", "B3", "D4", "F4"], // G7
    ["E3", "G3", "B3", "D4"], // Em7
    ["A2", "C3", "E3", "G3"]  // Am7
];

// メロディ用スケール (C Major Scale)
const scale = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5"];

// ==========================================
// 3. 音源セットアップ
// ==========================================
let leadSynth, chordSynth, bassSynth, drumKit;
let masterFilter, delay;

function setupAudio() {
    // エフェクト
    masterFilter = new Tone.Filter(1000, "lowpass").toDestination();
    delay = new Tone.FeedbackDelay("8n.", 0.3).connect(masterFilter);

    // 1. リードシンセ (メロディ用) - 抜けの良い音
    leadSynth = new Tone.Synth({
        oscillator: { type: "square" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 1 },
        volume: -8
    }).connect(delay);

    // 2. コードシンセ - ふわっとした音
    chordSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 },
        volume: -10
    }).connect(masterFilter);

    // 3. ベース - 太い音
    bassSynth = new Tone.FMSynth({
        harmonicity: 1, modulationIndex: 3.5,
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.5 },
        modulationEnvelope: { attack: 0.1, decay: 0.3, sustain: 0.1 },
        volume: -5
    }).connect(masterFilter);

    // 4. ドラム
    drumKit = {
        kick: new Tone.MembraneSynth({ volume: -2 }).connect(masterFilter),
        hat: new Tone.MetalSynth({ frequency: 200, envelope: { decay: 0.05 }, harmonicity: 5.1, volume: -15 }).connect(masterFilter)
    };
}

// ==========================================
// 4. シーケンサー (自動演奏ロジック)
// ==========================================
let tick = 0;

function startLoop() {
    Tone.Transport.bpm.value = 110; // 基本BPM

    Tone.Transport.scheduleRepeat((time) => {
        // --- 状態判定 ---
        // 0.0-0.3: Low, 0.3-0.7: Mid, 0.7-1.0: High
        const intensity = smoothedActivity;

        const beat16 = tick % 16;
        const barIndex = Math.floor(tick / 16) % 4; // 0,1,2,3 (コード進行の位置)

        // --- A. コード (王道進行ループ) ---
        // 各小節の頭(beat16===0)と、裏拍で鳴らす
        if (beat16 === 0) {
            chordSynth.triggerAttackRelease(chordProgression[barIndex], "2n", time);
        }
        if (intensity > 0.4 && beat16 === 8) { // 少し動くと裏拍にもコードが入る
            chordSynth.triggerAttackRelease(chordProgression[barIndex], "8n", time);
        }

        // --- B. ベース ---
        if (beat16 === 0 || (intensity > 0.5 && beat16 === 10)) {
            // コードのルート音を鳴らす
            const root = chordProgression[barIndex][0].replace("3", "2").replace("4","3"); // オクターブ下げる
            bassSynth.triggerAttackRelease(root, "8n", time);
        }

        // --- C. メロディ (可変アレンジ) ---
        // ここが今回の肝。activityが高いほど「細かく」「高く」なる。
        playDynamicMelody(time, intensity, beat16);

        // --- D. ドラム ---
        if (beat16 % 4 === 0) drumKit.kick.triggerAttackRelease("C1", "8n", time);
        if (intensity > 0.2 && beat16 % 2 === 0) drumKit.hat.triggerAttackRelease("32n", time); // 8分
        if (intensity > 0.7 && beat16 % 1 === 0) drumKit.hat.triggerAttackRelease("32n", time); // 16分連打

        tick++;
    }, "16n");

    Tone.Transport.start();
}

// メロディ生成関数
function playDynamicMelody(time, act, beat) {
    let playChance = 0;
    let noteDuration = "8n";
    let noteIndexOffset = 0;

    if (act < 0.3) {
        // Lv1: 静止〜歩き (4分音符中心、音数少ない)
        if (beat % 4 === 0) playChance = 0.8; 
    } else if (act < 0.7) {
        // Lv2: 小走り (8分音符、シンコペーションあり)
        if (beat % 2 === 0) playChance = 0.7;
        else if (Math.random() > 0.5) playChance = 0.4; // 裏拍
        noteIndexOffset = 2; // 少し音程上げる
    } else {
        // Lv3: 疾走 (16分音符、アルペジオ的、高音)
        playChance = 0.9; // ほぼ鳴りっぱなし
        noteDuration = "16n";
        noteIndexOffset = 5; // オクターブ近く上げる
    }

    if (Math.random() < playChance) {
        // ランダムにスケールから音を選ぶ
        // actが高いほど、高い音が選ばれやすくする
        const range = Math.floor(act * 5); 
        const idx = Math.floor(Math.random() * 5) + noteIndexOffset + range;
        
        // スケール外にはみ出さない処理
        const note = scale[Math.min(idx, scale.length - 1)];
        leadSynth.triggerAttackRelease(note, noteDuration, time);
    }
}

// ==========================================
// 5. 更新ループ (センサー & 画面 & パラメータ)
// ==========================================
function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    // スムージング
    smoothedActivity += (activity - smoothedActivity) * 0.05;

    // パラメータ連動
    // 1. BPM変化: 110 -> 160
    Tone.Transport.bpm.rampTo(110 + (smoothedActivity * 50), 0.1);

    // 2. フィルターの明るさ
    masterFilter.frequency.rampTo(500 + (smoothedActivity * 8000), 0.1);

    // 画面更新
    document.getElementById('actVal').innerText = Math.round(smoothedActivity * 100) + "%";
    
    // レベル表示
    const lvlText = document.getElementById('lvlText');
    const b1 = document.getElementById('b1');
    const b2 = document.getElementById('b2');
    const b3 = document.getElementById('b3');
    const b4 = document.getElementById('b4');

    // バーの高さアニメーション
    const h = smoothedActivity * 100;
    b1.style.height = (h * 0.8 + Math.random()*20) + "%";
    b2.style.height = (h * 1.0 + Math.random()*20) + "%";
    b3.style.height = (h * 1.2 + Math.random()*20) + "%";
    b4.style.height = (h * 0.9 + Math.random()*20) + "%";

    if(smoothedActivity < 0.3) {
        lvlText.innerText = "WALK";
        lvlText.style.color = "#00d1b2"; // Green
    } else if(smoothedActivity < 0.7) {
        lvlText.innerText = "RUN";
        lvlText.style.color = "#ffdd57"; // Yellow
    } else {
        lvlText.innerText = "DASH!!";
        lvlText.style.color = "#ff0055"; // Red
    }
}

// ==========================================
// 6. センサー入力
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    
    // 変化量を簡易計算 (ハイパス的な挙動)
    const x = a.x || 0; const y = a.y || 0; const z = a.z || 0;
    const mag = Math.sqrt(x*x + y*y + z*z);
    
    motionBuffer.push(mag);
    if(motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();

    // 標準偏差
    const mean = motionBuffer.reduce((a,b)=>a+b,0) / motionBuffer.length;
    const variance = motionBuffer.reduce((a,b)=>a+Math.pow(b-mean,2),0) / motionBuffer.length;
    const stdDev = Math.sqrt(variance);

    // 感度調整 (0.0 - 1.0)
    activity = Math.min(stdDev / 6.0, 1.0);
}

// ==========================================
// 7. 開始処理
// ==========================================
document.getElementById('playBtn').addEventListener('click', async () => {
    // iOS Permission
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const state = await DeviceMotionEvent.requestPermission();
        if (state !== 'granted') return alert("センサー許可が必要です");
    }
    
    window.addEventListener('devicemotion', handleMotion);
    await Tone.start();
    
    setupAudio();
    startLoop();
    
    isPlaying = true;
    update();
    
    document.getElementById('playBtn').style.display = 'none';
});

</script>
</body>
</html>