<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian Hardbass Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            background: #111; 
            color: #ccc; 
            text-align: center; 
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
        }
        
        #playBtn {
            padding: 20px 60px; 
            font-size: 1.5rem; 
            font-weight: bold;
            background: #333; 
            color: #fff; 
            border: 2px solid #555; 
            border-radius: 8px;
            cursor: pointer;
        }
        
        .status-container {
            margin-top: 40px;
            border: 1px solid #333;
            padding: 20px;
            width: 80%;
            max-width: 400px;
            background: #000;
        }

        .label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .value { font-size: 2rem; font-weight: bold; color: #fff; font-family: monospace; }
        #bpmVal { color: #ff3333; }
    </style>
</head>
<body>

    <button id="playBtn">SYSTEM START</button>

    <div class="status-container">
        <div class="label">STATUS</div>
        <div class="value" id="statusText">STANDBY</div>
        <br>
        <div class="label">BPM</div>
        <div class="value" id="bpmVal">---</div>
        <br>
        <div class="label">INTENSITY</div>
        <div class="value" id="speedVal">0%</div>
    </div>

<script>
// ==========================================
// 1. 変数定義
// ==========================================
let isPlaying = false;
let smoothedActivity = 0.0;
const motionBuffer = [];

// A Harmonic Minor Scale (A, B, C, D, E, F, G#, A)
// ロシアン・ハードベースによくある哀愁漂うスケール
const scaleNotes = ["A3", "B3", "C4", "D4", "E4", "F4", "G#4", "A4"];

// コード進行: Am -> Dm -> E -> Am
const progression = [
    ["A2", "A3"], // Am (Root Octaves)
    ["D2", "D3"], // Dm
    ["E2", "E3"], // E
    ["A2", "A3"]  // Am
];

// ==========================================
// 2. 音源セットアップ (Beat Emphasis Tuning)
// ==========================================
let kick, snare, donkBass, leadSynth, hihat;
let masterLimiter, distortion;

function setupAudio() {
    masterLimiter = new Tone.Limiter(-0.5).toDestination();
    
    // 歪みエフェクト（Activityに応じて強くなる）
    distortion = new Tone.Distortion(0).connect(masterLimiter);

    // 1. Hard Kick: アタックを強調し、よりタイトに
    kick = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 8, // ピッチ変化を大きくしてパンチを出す
        oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.8 },
        volume: 2 // 他より少し大きく
    }).connect(masterLimiter);

    // 2. Donk Bass: ロシアンビートの象徴「土管のような音」
    donkBass = new Tone.FMSynth({
        harmonicity: 3.01, // 少しズラして金属感を出す
        modulationIndex: 15,
        detune: 0,
        oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.3, sustain: 0.1, release: 0.1 },
        modulation: { type: "square" },
        modulationEnvelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 },
        volume: 0
    }).connect(distortion);

    // 3. Snare: クラップ音に近いノイズ
    snare = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.001, decay: 0.15, sustain: 0 },
        volume: -8
    }).connect(distortion);

    // 4. Hi-hat: チキチキ音
    hihat = new Tone.MetalSynth({
        frequency: 200,
        envelope: { attack: 0.001, decay: 0.05, release: 0.05 },
        harmonicity: 5.1,
        modulationIndex: 32,
        resonance: 4000,
        octaves: 1.5,
        volume: -15
    }).connect(distortion);

    // 5. Lead: 矩形波でチープかつ激しく
    leadSynth = new Tone.Synth({
        oscillator: { type: "square" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 },
        volume: -10
    }).connect(distortion);
}

// ==========================================
// 3. シーケンサー (Rhythm & Logic)
// ==========================================
let tick = 0;

function startLoop() {
    // 初期BPM
    Tone.Transport.bpm.value = 90;

    Tone.Transport.scheduleRepeat((time) => {
        const act = smoothedActivity;
        const beat16 = tick % 16;
        const beat4 = tick % 4;
        const barIdx = Math.floor(tick / 16) % 4;
        
        // --- A. KICK (心臓部) ---
        // 常に4つ打ち。Activityが低いときは重く、高いときは短く鳴らすなどの変化も可能だが、
        // ハードベースは「変わらない強さ」が重要なので一定に。
        if (beat4 === 0) {
            kick.triggerAttackRelease("A1", "8n", time);
        }

        // --- B. BASS (裏打ちの強調) ---
        // Activity > 0.3 で裏打ち開始。
        // ここが「BPMの変化」を感じさせる最大のポイント。
        if (act > 0.3) {
            if (beat4 === 2) { // 典型的裏打ち (Don - [DONK] - Don - [DONK])
                const note = progression[barIdx][0]; // Root note
                donkBass.triggerAttackRelease(note, "8n", time);
            }
        }
        
        // --- C. SNARE & HIHAT ---
        // 勢いづけ
        if (act > 0.5) {
            if (beat16 % 8 === 4) { // 2拍目と4拍目
                snare.triggerAttackRelease("8n", time);
            }
            if (beat4 === 2) { // 裏打ちハイハット
                hihat.triggerAttackRelease("32n", time);
            }
        }

        // --- D. MELODY ---
        // テトリスっぽいフレーズを生成
        if (act > 0.2) {
            playMelody(time, act, beat16, barIdx);
        }

        tick++;
    }, "16n");

    Tone.Transport.start();
}

function playMelody(time, act, beat, barIdx) {
    let playChance = 0;
    
    // 静: メロディなし
    if (act < 0.4) return;

    // 動: 8分音符でランダム
    if (act < 0.8) {
        if (beat % 2 === 0 && Math.random() < 0.7) {
            // スケールからランダム
            const n = scaleNotes[Math.floor(Math.random() * 4)]; // 低めの音
            leadSynth.triggerAttackRelease(n, "8n", time);
        }
    } 
    // 激: 16分音符で駆け上がり
    else {
        // アルペジオ
        const idx = tick % 8;
        const n = scaleNotes[idx]; 
        leadSynth.triggerAttackRelease(n, "16n", time);
    }
}

// ==========================================
// 4. 更新ループ (パラメータ制御)
// ==========================================
function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    // センサー値スムージング
    const raw = motionBuffer.length ? motionBuffer[motionBuffer.length-1] : 0;
    smoothedActivity += (raw - smoothedActivity) * 0.1;

    // --- BPM制御 (修正ポイント) ---
    // 90 (Walk) 〜 170 (Sprint)
    // 変化の幅を大きくし、少し動くだけで130くらいまで一気に上がるカーブにする
    // Math.powを使うことで「頑張って振ると急激に速くなる」演出
    const curve = Math.pow(smoothedActivity, 0.8); // 直線より少し早めに立ち上がる
    const targetBpm = 90 + (curve * 80); 
    Tone.Transport.bpm.rampTo(targetBpm, 0.2); // 追従速度を少し速く(0.2s)

    // --- 音色制御 ---
    // 激しくなると少し音が歪んで攻撃的になる
    distortion.distortion = Math.max(0, (smoothedActivity - 0.6) * 0.5);

    // --- 表示更新 ---
    document.getElementById('bpmVal').innerText = Math.round(targetBpm);
    document.getElementById('speedVal').innerText = Math.round(smoothedActivity * 100) + "%";
    
    const statusText = document.getElementById('statusText');
    if (smoothedActivity < 0.3) statusText.innerText = "SNEAKING";
    else if (smoothedActivity < 0.7) statusText.innerText = "MOVING";
    else statusText.innerText = "HARD BASS!!";
    
    // 文字色変化
    if (smoothedActivity > 0.7) {
        statusText.style.color = "#ff3333";
        document.body.style.borderColor = "#ff3333";
    } else {
        statusText.style.color = "#fff";
        document.body.style.borderColor = "#333";
    }
}

// ==========================================
// 5. センサー入力
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    const x = a.x || 0; const y = a.y || 0; const z = a.z || 0;
    const mag = Math.sqrt(x*x + y*y + z*z);
    
    // 9.8(重力)を引いて純粋な動きの量を取る
    const shake = Math.abs(mag - 9.8);
    
    // 感度調整: 激しく振って 1.0 になるように
    const normalized = Math.min(shake / 6.0, 1.0);
    
    motionBuffer.push(normalized);
    if(motionBuffer.length > 10) motionBuffer.shift();
}

// ==========================================
// 6. 開始処理
// ==========================================
document.getElementById('playBtn').addEventListener('click', async () => {
    // iOS Permission
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const state = await DeviceMotionEvent.requestPermission();
        if (state !== 'granted') return alert("センサー許可が必要です");
    }
    
    window.addEventListener('devicemotion', handleMotion);
    await Tone.start();
    
    setupAudio();
    startLoop();
    
    isPlaying = true;
    update();
    
    document.getElementById('playBtn').style.display = 'none';
});
</script>
</body>
</html>