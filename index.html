<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nature to Speed (Kick & BPM Mod)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a24; color: #fff; text-align: center; padding: 20px; overflow: hidden; user-select: none; }
        
        #playBtn {
            margin-top: 35vh;
            padding: 20px 60px; font-size: 1.2rem; font-weight: bold;
            color: #fff; background: linear-gradient(135deg, #20c997, #0077ff);
            border: none; border-radius: 50px;
            box-shadow: 0 0 20px rgba(32, 201, 151, 0.5); transition: transform 0.1s;
        }
        #playBtn:active { transform: scale(0.95); }

        .hud { position: absolute; top: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 10; pointer-events: none;}
        .status-label { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .sub-label { font-size: 0.9rem; color: #aaa; font-family: monospace; }

        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            opacity: 0.8; transition: background 1s;
        }
        
        .bird-visual {
            position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="hud">
        <div class="status-label" id="statusText">WALK</div>
        <div class="sub-label">BPM: <span id="bpmVal">80</span> | SPEED: <span id="speedVal">0%</span></div>
    </div>

    <button id="playBtn">START JOURNEY</button>

<script>
// ==========================================
// 1. システム設定
// ==========================================
let isPlaying = false;
let smoothedActivity = 0.0;
const BUFFER_SIZE = 10;
const motionBuffer = [];

// ==========================================
// 2. 音楽理論データ (Key: C Major)
// ==========================================
const chords = [
    { name: "FM7", notes: ["F3", "A3", "C4", "E4"] },
    { name: "G7",  notes: ["G3", "B3", "D4", "F4"] },
    { name: "Em7", notes: ["E3", "G3", "B3", "D4"] },
    { name: "Am7", notes: ["A3", "C4", "E4", "G4"] } 
];

const arpeggioNotes = [
    ["F4", "A4", "C5", "E5", "F5", "A5"], 
    ["G4", "B4", "D5", "F5", "G5", "B5"], 
    ["E4", "G4", "B4", "D5", "E5", "G5"], 
    ["A4", "C5", "E5", "G5", "A5", "C6"]  
];

// ==========================================
// 3. 音源セットアップ
// ==========================================
let leadSynth, chordSynth, bassSynth, drumKit;
let windNode, windGain, windFilter;
let birdSynth, birdPan;

function setupAudio() {
    const limiter = new Tone.Limiter(-0.5).toDestination();
    const reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).connect(limiter);

    // 楽器類（元の構成のまま）
    leadSynth = new Tone.Synth({
        oscillator: { type: "triangle" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 },
        volume: -6
    }).connect(reverb);

    chordSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "sine" },
        envelope: { attack: 0.1, decay: 0.3, sustain: 0.4, release: 1 },
        volume: -10
    }).connect(reverb);

    bassSynth = new Tone.FMSynth({
        harmonicity: 1, modulationIndex: 2,
        envelope: { attack: 0.05, decay: 0.2, sustain: 0.8, release: 0.5 },
        volume: -6
    }).connect(limiter);

    drumKit = {
        // キックの音量は少し聞こえやすく調整 (volume: -4 -> 0)
        kick: new Tone.MembraneSynth({ volume: 0 }).connect(limiter),
        hat: new Tone.MetalSynth({ frequency: 200, envelope: { decay: 0.05 }, volume: -22 }).connect(limiter)
    };

    // 風
    windFilter = new Tone.Filter({ type: "bandpass", frequency: 200, Q: 0.5 });
    windGain = new Tone.Gain(0).connect(limiter);
    windNode = new Tone.Noise("pink").connect(windFilter).connect(windGain);
    windNode.start();

    // 鳥
    birdPan = new Tone.Panner(0).connect(reverb);
    birdSynth = new Tone.Synth({
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 },
        volume: -12
    }).connect(birdPan);
}

// ==========================================
// 4. 鳥の生成ロジック
// ==========================================
function triggerBird() {
    birdPan.pan.value = (Math.random() * 2) - 1;
    const freq = 1000 + Math.random() * 2000;
    const now = Tone.now();
    
    birdSynth.triggerAttackRelease(freq, "32n", now);
    birdSynth.frequency.rampTo(freq + 500, 0.05, now);

    if (Math.random() > 0.5) {
        birdSynth.triggerAttackRelease(freq + 200, "32n", now + 0.1);
    }
    showBirdVisual();
}

function showBirdVisual() {
    const el = document.createElement('div');
    el.className = 'bird-visual';
    el.style.left = (Math.random() * 80 + 10) + '%';
    el.style.top = (Math.random() * 60 + 10) + '%';
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = 1; }, 10);
    setTimeout(() => { el.style.opacity = 0; }, 500);
    setTimeout(() => { el.remove(); }, 1000);
}

// ==========================================
// 5. シーケンサー
// ==========================================
let tick = 0;

function startLoop() {
    Tone.Transport.bpm.value = 80; // 初期BPM

    Tone.Transport.scheduleRepeat((time) => {
        const intensity = smoothedActivity; 
        
        const beat16 = tick % 16;
        const barIndex = Math.floor(tick / 16) % 4;
        const currentChord = chords[barIndex];

        // --- 1. 鳥 (Low Activityのみ) ---
        if (intensity < 0.3) {
            if (Math.random() < 0.05) triggerBird();
        }

        // --- 2. コード (常に) ---
        if (beat16 === 0) {
            chordSynth.triggerAttackRelease(currentChord.notes, "2n", time);
        }

        // --- 3. ベース & ドラム（★ここを修正：キックのパターン変化） ---
        
        // ベースは元のまま
        if (beat16 === 0) {
             const root = currentChord.notes[0].replace("3","2").replace("4","3");
             bassSynth.triggerAttackRelease(root, "8n", time);
        }
        
        // ★キック（バスドラム）の制御
        // 基本: 小節の頭(0)で鳴る
        // 動き出した(intensity > 0.4): 4分音符(0, 4, 8, 12)で鳴る＝4つ打ち
        const isQuarterNote = (beat16 % 4 === 0);
        
        if (beat16 === 0) {
            // 頭拍は必ず鳴らす
            drumKit.kick.triggerAttackRelease("C1", "8n", time);
        } else if (intensity > 0.4 && isQuarterNote) {
            // 動きがあれば残りの拍も鳴らす（ドン・ドン・ドン・ドン）
            drumKit.kick.triggerAttackRelease("C1", "8n", time);
        }

        // ハイハットなどは元のロジック
        if (intensity > 0.5) {
            if (beat16 === 10) {
                const root = currentChord.notes[0].replace("3","2").replace("4","3");
                bassSynth.triggerAttackRelease(root, "8n", time);
            }
            if (beat16 % 4 === 0) drumKit.hat.triggerAttackRelease("32n", time);
        }
        
        if (intensity > 0.8) {
            drumKit.hat.triggerAttackRelease("32n", time);
        }

        // --- 4. メロディ (元のまま) ---
        playMelody(time, intensity, beat16, barIndex);

        tick++;
    }, "16n");

    Tone.Transport.start();
}

function playMelody(time, act, beat, chordIdx) {
    if (act < 0.3) {
        if (beat === 0 && Math.random() > 0.5) {
            leadSynth.triggerAttackRelease(chords[chordIdx].notes[2], "4n", time);
        }
        return;
    }
    if (act > 0.6) {
        const density = act > 0.8 ? 1 : 2; 
        if (tick % density === 0) {
            const arpNotes = arpeggioNotes[chordIdx];
            const noteIndex = tick % arpNotes.length; 
            leadSynth.triggerAttackRelease(arpNotes[noteIndex], "16n", time);
        }
    } else {
        if (beat % 2 === 0 && Math.random() < 0.5) {
            const notes = chords[chordIdx].notes;
            const note = notes[Math.floor(Math.random() * notes.length)];
            leadSynth.triggerAttackRelease(note, "8n", time);
        }
    }
}

// ==========================================
// 6. 更新ループ (風 & 背景 & BPM)
// ==========================================
function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    smoothedActivity += ((motionBuffer.length ? motionBuffer[motionBuffer.length-1] : 0) - smoothedActivity) * 0.05;
    smoothedActivity = Math.max(0, Math.min(1, smoothedActivity));

    // --- 風制御 ---
    let windVol = Math.max(0, (smoothedActivity - 0.2) * 0.25); 
    windGain.gain.rampTo(windVol, 0.1);

    const windFreq = 200 + (smoothedActivity * 1000);
    windFilter.frequency.rampTo(windFreq, 0.1);

    // --- 背景色制御 ---
    const bg = document.getElementById('bg-layer');
    const statusText = document.getElementById('statusText');
    const speedVal = document.getElementById('speedVal');
    const bpmVal = document.getElementById('bpmVal');

    speedVal.innerText = Math.round(smoothedActivity * 100) + "%";
    
    // ★BPM制御（ここを修正：可変幅を大きく）
    // 0% -> BPM 80
    // 100% -> BPM 180
    const targetBpm = 80 + (smoothedActivity * 100);
    Tone.Transport.bpm.rampTo(targetBpm, 0.1);
    bpmVal.innerText = Math.round(Tone.Transport.bpm.value);

    if (smoothedActivity < 0.3) {
        bg.style.background = "linear-gradient(to bottom, #87CEEB, #E0F7FA)";
        statusText.innerText = "NATURE WALK";
        statusText.style.color = "#fff";
    } else if (smoothedActivity < 0.7) {
        bg.style.background = "linear-gradient(to bottom, #6a11cb, #2575fc)";
        statusText.innerText = "RUNNING";
        statusText.style.color = "#ffeb3b";
    } else {
        bg.style.background = "linear-gradient(to bottom, #44000b, #000)";
        statusText.innerText = "GALAXY DASH";
        statusText.style.color = "#ff0055";
    }
}

// ==========================================
// 7. センサー入力
// ==========================================
function handleMotion(event) {
    const a = event.accelerationIncludingGravity;
    if (!a) return;
    const x = a.x || 0; const y = a.y || 0; const z = a.z || 0;
    const mag = Math.sqrt(x*x + y*y + z*z);
    const shake = Math.abs(mag - 9.8); 
    const normalized = Math.min(shake / 5.0, 1.0);
    motionBuffer.push(normalized);
    if(motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
}

document.getElementById('playBtn').addEventListener('click', async () => {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        const state = await DeviceMotionEvent.requestPermission();
        if (state !== 'granted') return alert("センサー許可が必要です");
    }
    window.addEventListener('devicemotion', handleMotion);
    await Tone.start();
    setupAudio();
    startLoop();
    isPlaying = true;
    update();
    document.getElementById('playBtn').style.display = 'none';
});
</script>
</body>
</html>