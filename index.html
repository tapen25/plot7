<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Tone.js 3 Synth Loop Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.22/Tone.js"></script>

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding-top: 40px;
      user-select: none;
    }
    h1 { font-size: 1.5rem; margin-bottom: 2rem; }
    
    .mixer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 40px;
    }

    .track-btn {
      font-size: 18px;
      padding: 15px 30px;
      border: 2px solid #555;
      background: #222;
      color: #888;
      border-radius: 50px;
      cursor: pointer;
      width: 280px;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .track-btn.active {
      background: #eee;
      color: #111;
      border-color: #fff;
      box-shadow: 0 0 15px rgba(255,255,255,0.4);
      transform: scale(1.02);
    }
    
    /* è‰²åˆ†ã‘ */
    .track-btn[data-type="poly"].active { background: #00d2ff; border-color: #00d2ff; }
    .track-btn[data-type="fm"].active { background: #ff4b1f; border-color: #ff4b1f; }
    .track-btn[data-type="mono"].active { background: #1eff00; border-color: #1eff00; }

    #start {
      font-size: 16px;
      padding: 10px 20px;
      margin-bottom: 30px;
      cursor: pointer;
    }
    .status {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <h1>ğŸ¹ Loop Layering System</h1>

  <div class="status">Step 1: Audio Startã‚’æŠ¼ã—ã¦å†ç”Ÿé–‹å§‹</div>
  <button id="start">â–¶ AUDIO START (Sequence)</button>

  <hr style="border-color:#333; width: 50%; margin: 20px auto;">

  <div class="status">Step 2: ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¥½å™¨ã‚’é‡ã­ã‚‹</div>
  
  <div class="mixer">
    <button class="track-btn" id="btnPoly" data-type="poly">
      <span>â‘  Chords (Poly)</span>
      <span>OFF</span>
    </button>

    <button class="track-btn" id="btnFM" data-type="fm">
      <span>â‘¡ Metallic (FM)</span>
      <span>OFF</span>
    </button>

    <button class="track-btn" id="btnMono" data-type="mono">
      <span>â‘¢ Bass (Mono)</span>
      <span>OFF</span>
    </button>
  </div>

  <script>
    const patterns = {
      A: ["G4","A4","B4","C5","B4","A4","G4","A4","B4"],
      B: ["G4","A4","B4","C5","B4","A4","G4","B4","G4"]
    };
    const durations = [0.25, 0.25, 0.25, 0.25, 0.5, 0.5, 0.5, 0.5, 1.0];

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å®£è¨€ï¼ˆä¸­èº«ã¯ã¾ã ç©ºï¼‰
    let polySynth, fmSynth, monoSynth;
    let isPlaying = false;

    // --- Audio Start ãƒœã‚¿ãƒ³ ---
    document.getElementById("start").addEventListener("click", async (e) => {
      if (isPlaying) return;
      
      await Tone.start();
      Tone.Transport.bpm.value = 130; 

      // 1. ã‚·ãƒ³ã‚»åˆæœŸåŒ– (ã“ã“ã§å¤‰æ•°ã«ä¸­èº«ãŒå…¥ã‚‹)
      polySynth = new Tone.PolySynth(Tone.Synth, {
        volume: -Infinity,
        oscillator: { type: "triangle" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
      }).toDestination();

      fmSynth = new Tone.FMSynth({
        volume: -Infinity,
        harmonicity: 3,
        modulationIndex: 10,
        envelope: { attack: 0.01, decay: 0.2 },
        modulation: { type: "square" }
      }).toDestination();

      monoSynth = new Tone.PolySynth(Tone.MonoSynth, {
        volume: -Infinity,
        oscillator: { type: "square8" },
        filter: { type: "lowpass", rolloff: -12, Q: 1 },
        envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 }
      }).toDestination();


      // 2. è­œé¢ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
      const combinedNotes = [...patterns.A, ...patterns.B];
      const combinedDurs = [...durations, ...durations];
      
      let timeAccumulator = 0; 
      
      const partEvents = combinedNotes.map((note, i) => {
        const d = combinedDurs[i];
        
        let toneDuration;
        if(d === 0.25) toneDuration = "16n";
        else if(d === 0.5) toneDuration = "8n";
        else toneDuration = "4n"; 

        const durationSeconds = Tone.Time(toneDuration).toSeconds();

        const event = { 
            time: timeAccumulator, 
            note: note, 
            dur: toneDuration 
        };
        
        timeAccumulator += durationSeconds;
        return event;
      });

      // Partä½œæˆ
      const part = new Tone.Part((time, value) => {
        // å„ã‚·ãƒ³ã‚»å¤‰æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰é³´ã‚‰ã™ï¼ˆå®‰å…¨æ€§ã®ãŸã‚ï¼‰
        if(polySynth) polySynth.triggerAttackRelease(value.note, value.dur, time);
        if(fmSynth) fmSynth.triggerAttackRelease(value.note, "16n", time);
        
        if(monoSynth) {
          const bassNote = Tone.Frequency(value.note).transpose(-12); 
          monoSynth.triggerAttackRelease(bassNote, value.dur, time);
        }
      }, partEvents);

      part.loop = true;
      part.loopEnd = timeAccumulator;
      part.start(0);

      Tone.Transport.start();
      
      isPlaying = true;
      e.target.innerText = "Playing... (Click buttons below)";
      e.target.disabled = true;
    });


    // --- ãƒœã‚¿ãƒ³æ“ä½œã®ä¿®æ­£ ---
    // ã“ã“ã§ç›´æ¥ã‚·ãƒ³ã‚»å¤‰æ•°ã‚’æ¸¡ã•ãšã€ã€Œåå‰ã€ã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸ
    function toggleTrack(btnId, type, activeVolume) {
      const btn = document.getElementById(btnId);
      let isActive = false;

      btn.addEventListener("click", () => {
        if (!isPlaying) {
          alert("ã¾ãš 'AUDIO START' ã‚’æŠ¼ã—ã¦ãã ã•ã„");
          return;
        }

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸç¬é–“ã«ã€æ­£ã—ã„å¤‰æ•°ã‚’é¸ã¶
        let targetSynth;
        if (type === 'poly') targetSynth = polySynth;
        else if (type === 'fm') targetSynth = fmSynth;
        else if (type === 'mono') targetSynth = monoSynth;

        // ã¾ã ã‚·ãƒ³ã‚»ãŒæº–å‚™ã§ãã¦ã„ãªã‘ã‚Œã°ä¸­æ–­
        if (!targetSynth) return;

        isActive = !isActive;

        if (isActive) {
          btn.classList.add("active");
          btn.querySelector("span:last-child").innerText = "ON";
          targetSynth.volume.rampTo(activeVolume, 0.1);
        } else {
          btn.classList.remove("active");
          btn.querySelector("span:last-child").innerText = "OFF";
          targetSynth.volume.rampTo(-Infinity, 0.1);
        }
      });
    }

    // å‘¼ã³å‡ºã—å´ã‚‚ã€Œå¤‰æ•°ãã®ã‚‚ã®ã€ã§ã¯ãªãã€Œã‚¿ã‚¤ãƒ—åã€ã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
    toggleTrack("btnPoly", "poly", -5);  
    toggleTrack("btnFM", "fm", -5);
    toggleTrack("btnMono", "mono", -8);

  </script>
</body>
</html>