<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Tone.js 3 Synth Loop Layering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.22/Tone.js"></script>

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding-top: 40px;
      user-select: none;
    }
    h1 { font-size: 1.5rem; margin-bottom: 2rem; }
    
    /* ãƒˆãƒ©ãƒƒã‚¯æ“ä½œã‚¨ãƒªã‚¢ */
    .mixer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 40px;
    }

    .track-btn {
      font-size: 18px;
      padding: 15px 30px;
      border: 2px solid #555;
      background: #222;
      color: #888;
      border-radius: 50px;
      cursor: pointer;
      width: 280px;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* æŠ¼ã•ã‚ŒãŸçŠ¶æ…‹ï¼ˆActiveï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .track-btn.active {
      background: #eee;
      color: #111;
      border-color: #fff;
      box-shadow: 0 0 15px rgba(255,255,255,0.4);
      transform: scale(1.02);
    }
    
    /* å„æ¥½å™¨ã”ã¨ã®è‰²åˆ†ã‘ï¼ˆã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰ */
    .track-btn[data-inst="poly"].active { background: #00d2ff; border-color: #00d2ff; }
    .track-btn[data-inst="fm"].active { background: #ff4b1f; border-color: #ff4b1f; }
    .track-btn[data-inst="mono"].active { background: #1eff00; border-color: #1eff00; }

    #start {
      font-size: 16px;
      padding: 10px 20px;
      margin-bottom: 30px;
      cursor: pointer;
    }
    .status {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <h1>ğŸ¹ Loop Layering System</h1>

  <div class="status">Step 1: Audio Startã‚’æŠ¼ã—ã¦å†ç”Ÿé–‹å§‹</div>
  <button id="start">â–¶ AUDIO START (Sequence)</button>

  <hr style="border-color:#333; width: 50%; margin: 20px auto;">

  <div class="status">Step 2: ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ¥½å™¨ã‚’é‡ã­ã‚‹</div>
  
  <div class="mixer">
    <button class="track-btn" id="btnPoly" data-inst="poly">
      <span>â‘  Chords (Poly)</span>
      <span>OFF</span>
    </button>

    <button class="track-btn" id="btnFM" data-inst="fm">
      <span>â‘¡ Metallic (FM)</span>
      <span>OFF</span>
    </button>

    <button class="track-btn" id="btnMono" data-inst="mono">
      <span>â‘¢ Bass (Mono)</span>
      <span>OFF</span>
    </button>
  </div>

  <script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const patterns = {
      A: ["G4","A4","B4","C5","B4","A4","G4","A4","B4"],
      B: ["G4","A4","B4","C5","B4","A4","G4","B4","G4"]
    };
    // ãƒªã‚ºãƒ ï¼ˆ1.0 = 4åˆ†éŸ³ç¬¦ï¼‰
    const durations = [0.25, 0.25, 0.25, 0.25, 0.5, 0.5, 0.5, 0.5, 1.0];

    // --- å¤‰æ•° ---
    let polySynth, fmSynth, monoSynth;
    let isPlaying = false;

    // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰ ---
    // Aã¨Bã‚’ã¤ãªã’ã¦1ã¤ã®ãƒ«ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹é–¢æ•°
    function createMelodyEvents() {
      const fullMelody = [...patterns.A, ...patterns.B];
      const fullDurations = [...durations, ...durations]; // Aã¨Bã§åŒã˜ãƒªã‚ºãƒ ã‚’ä½¿ã†
      
      let currentTime = 0;
      const events = [];

      fullMelody.forEach((note, index) => {
        // ãƒªã‚ºãƒ æ•°å€¤(1.0)ã‚’Tone.jsã®è¨˜æ³•("4n")ã®ç§’æ•°ã«æ›ç®—ã™ã‚‹ãŸã‚ã®ä¿‚æ•°
        // ã“ã“ã§ã¯å˜ç´”ã« "1.0 = 4n" ã¨ä»®å®šã—ã¦è¨ˆç®—
        // Tone.Time("4n").toSeconds() * durationå€¤
        
        const durValue = fullDurations[index];
        // durationãŒ 0.25 ãªã‚‰ 16åˆ†éŸ³ç¬¦ç›¸å½“ã€1.0ãªã‚‰4åˆ†éŸ³ç¬¦ç›¸å½“
        // Tone.jsçš„ã«æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å°ç¯€(Measure)å˜ä½ã§ã¯ãªãã€
        // å˜ç´”ãªç´¯ç©æ™‚é–“(ç§’ã§ã¯ãªã„ãŒæ‹æ•°ã«è¿‘ã„æ¦‚å¿µ)ã¨ã—ã¦è¨ˆç®—ã—ã€å†ç”Ÿæ™‚ã«è§£æ±ºã•ã›ã¾ã™ã€‚
        
        events.push({
          time: currentTime,
          note: note,
          duration: durValue
        });

        // æ¬¡ã®éŸ³ã®é–‹å§‹æ™‚é–“ã‚’åŠ ç®— (1.0 = 1æ‹ = Tone.Transport.PPQ)
        // ã“ã“ã§ã¯ä¾¿å®œä¸Šã€Quarter NoteåŸºæº–ã§æ™‚é–“ã‚’ç©ç®—ã—ã¾ã™
        currentTime += durValue * (60 / 120); // åˆæœŸBPM120ä»®å®šã§ã®ç§’æ•°æ›ç®—ã«è¿‘ã„å‡¦ç†
        // â€»æ­£ç¢ºã«ã¯Tone.Partã¯ "0:0:0" å½¢å¼ã‚„ç§’æ•°ã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚
        // ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã€å†ç”Ÿæ™‚ã«ã€Œ16n * multiplierã€ã§é•·ã•ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
      });
      return events;
    }


    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    document.getElementById("start").addEventListener("click", async (e) => {
      if (isPlaying) return;
      
      await Tone.start();
      Tone.Transport.bpm.value = 130; // å°‘ã—ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—

      // 1. ã‚·ãƒ³ã‚»ã®åˆæœŸåŒ–ï¼ˆVolumeã¯ -Infinity ã§é–‹å§‹ï¼ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ï¼‰
      
      // â‘  PolySynth
      polySynth = new Tone.PolySynth(Tone.Synth, {
        volume: -Infinity, // æœ€åˆã¯èã“ãˆãªã„
        oscillator: { type: "triangle" },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
      }).toDestination();

      // â‘¡ FM Synth
      fmSynth = new Tone.FMSynth({
        volume: -Infinity, // æœ€åˆã¯èã“ãˆãªã„
        harmonicity: 3,
        modulationIndex: 10,
        envelope: { attack: 0.01, decay: 0.2 },
        modulation: { type: "square" }
      }).toDestination();

      // â‘¢ MonoSynth
      monoSynth = new Tone.PolySynth(Tone.MonoSynth, { // å’ŒéŸ³ã§æ¥ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«Polyã§ãƒ©ãƒƒãƒ—
        volume: -Infinity, // æœ€åˆã¯èã“ãˆãªã„
        oscillator: { type: "square8" },
        filter: { type: "lowpass", rolloff: -12, Q: 1 },
        envelope: { attack: 0.05, decay: 0.3, sustain: 0.4, release: 0.8 }
      }).toDestination();


      // 2. ãƒ«ãƒ¼ãƒ—å†ç”Ÿã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Tone.Part)
      // ãƒ‡ãƒ¼ã‚¿ä½œæˆ: Aãƒ‘ã‚¿ãƒ¼ãƒ³ + Bãƒ‘ã‚¿ãƒ¼ãƒ³
      // ãƒªã‚ºãƒ æ•°å€¤(0.25ç­‰)ã‚’Tone.jsã®æ™‚é–“("0:0:2"ç­‰)ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã®ã¯è¤‡é›‘ãªã®ã§ã€
      // ç´¯ç©æ™‚é–“(beat)ã‚’ä½¿ã£ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ã€‚
      
      const combinedNotes = [...patterns.A, ...patterns.B];
      const combinedDurs = [...durations, ...durations];
      
      let timeAccumulator = 0;
      const partEvents = combinedNotes.map((note, i) => {
        const d = combinedDurs[i];
        
        // 4åˆ†éŸ³ç¬¦=1.0 ã¨ã„ã†å®šç¾©ãªã®ã§ã€
        // 0.25 = 16åˆ†éŸ³ç¬¦(16n), 0.5 = 8åˆ†éŸ³ç¬¦(8n), 1.0 = 4åˆ†éŸ³ç¬¦(4n)
        let toneDuration;
        if(d === 0.25) toneDuration = "16n";
        else if(d === 0.5) toneDuration = "8n";
        else toneDuration = "4n";

        const event = { time: timeAccumulator, note: note, dur: toneDuration };
        
        // æ¬¡ã®é–‹å§‹æ™‚é–“ã‚’è¨ˆç®— (Tone.Timeã§è¶³ã—ç®—)
        timeAccumulator = Tone.Time(timeAccumulator).add(toneDuration).toNotation();
        
        return event;
      });

      // Partä½œæˆ
      const part = new Tone.Part((time, value) => {
        // 3ã¤ã®ã‚·ãƒ³ã‚»ã‚’åŒæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ï¼ˆéŸ³é‡ã¯volumeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§åˆ¶å¾¡ã•ã‚Œã‚‹ï¼‰
        
        // â‘  Poly: ãã®ã¾ã¾
        polySynth.triggerAttackRelease(value.note, value.dur, time);
        
        // â‘¡ FM: ãã®ã¾ã¾ (å°‘ã—çŸ­ãå¼¾ã)
        fmSynth.triggerAttackRelease(value.note, "16n", time);
        
        // â‘¢ Mono: ãƒ™ãƒ¼ã‚¹ãªã®ã§ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹ã’ã‚‹ (G4 -> G2)
        // Tone.Frequency(note).transpose(-24) ã§2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹
        const bassNote = Tone.Frequency(value.note).transpose(-12); 
        monoSynth.triggerAttackRelease(bassNote, value.dur, time);

      }, partEvents);

      part.loop = true;
      part.loopEnd = timeAccumulator; // è¨ˆç®—ã—ãŸåˆè¨ˆæ™‚é–“ãŒãƒ«ãƒ¼ãƒ—é•·
      part.start(0);

      // ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹
      Tone.Transport.start();
      
      isPlaying = true;
      e.target.innerText = "Playing... (Click buttons below)";
      e.target.disabled = true;
    });


    // --- ãƒœã‚¿ãƒ³æ“ä½œï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆ/ã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼‰ ---
    
    function toggleTrack(btnId, synth, activeVolume = 0) {
      const btn = document.getElementById(btnId);
      let isActive = false;

      btn.addEventListener("click", () => {
        if (!isPlaying) {
          alert("å…ˆã« 'AUDIO START' ã‚’æŠ¼ã—ã¦ãã ã•ã„");
          return;
        }

        isActive = !isActive;

        if (isActive) {
          // ON: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä¸Šã’ã‚‹
          btn.classList.add("active");
          btn.querySelector("span:last-child").innerText = "ON";
          synth.volume.rampTo(activeVolume, 0.1); // 0.1ç§’ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        } else {
          // OFF: ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä¸‹ã’ã‚‹ï¼ˆ-Infinityã§ç„¡éŸ³ï¼‰
          btn.classList.remove("active");
          btn.querySelector("span:last-child").innerText = "OFF";
          synth.volume.rampTo(-Infinity, 0.1); // 0.1ç§’ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        }
      });
    }

    // å„ãƒœã‚¿ãƒ³ã«æ©Ÿèƒ½ã‚’å‰²ã‚Šå½“ã¦
    // ç¬¬3å¼•æ•°ã¯ONã®ã¨ãã®éŸ³é‡(db)
    toggleTrack("btnPoly", polySynth, -2);  
    toggleTrack("btnFM", fmSynth, -2);
    toggleTrack("btnMono", monoSynth, -6); // ä½éŸ³ã¯å°‘ã—æ§ãˆã‚ã«

  </script>
</body>
</html>