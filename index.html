<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Synth with Tone.js (Fixed)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; }
  button { padding: 15px 30px; font-size: 1.2em; cursor: pointer; }
  #status, #debug { margin: 15px 0; font-size: 1.2em; }
  #debug { color: #666; font-size: 0.9em; }
</style>
</head>
<body>

<button id="start">Start (iOSã¯è¦ã‚¿ãƒƒãƒ—)</button>
<div id="status">åœæ­¢ä¸­</div>
<div id="debug">BPM: 0</div>

<script>
// ==========================================
// Tone.js ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼å®šç¾©
// ==========================================
// 1. ã“ã‚‚ã‚‹ï¼ˆPolySynthï¼‰
// å˜ãªã‚‹Synthã ã¨æ˜ã‚‹ã™ãã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€é«˜éŸ³ã‚’å°‘ã—å‰Šã‚‹è¨­å®šã«ã™ã‚‹ã¨ãªãŠè‰¯ã—
const polySynth = new Tone.PolySynth(Tone.Synth, {
  oscillator: { type: "sine" }, // ä¸‰è§’æ³¢ã‚ˆã‚Šã•ã‚‰ã«ä¸¸ã„ã‚µã‚¤ãƒ³æ³¢ã«å¤‰æ›´
  envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 }
}).toDestination();

// 2. ç››ã‚Šä¸ŠãŒã‚Šä¸­é–“ï¼ˆMonoSynthï¼‰
// ãƒã‚³ã‚®ãƒªæ³¢(sawtooth)ã«ã—ã¦ã€å°‘ã—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é–‹ãæ°—å‘³ã«
const monoSynth = new Tone.MonoSynth({
  oscillator: { type: "sawtooth" },
  filter: { Q: 2, type: "lowpass", rollover: -12, frequency: 800 }, // ã»ã©ã‚ˆã„å¤ªã•
  envelope: { attack: 0.01, decay: 0.1, sustain: 0.6, release: 1 },
  filterEnvelope: { attack: 0.01, decay: 0.5, sustain: 0.5, release: 2, baseFrequency: 200, octaves: 4 },
  volume: -4
}).toDestination();

// 3. æœ€å¤§é–‹æ”¾ï¼ˆFMSynthï¼‰
// ModulationIndexã‚’é«˜ã‚ã«ã—ã¦ã‚®ãƒ©ã‚®ãƒ©ã•ã›ã‚‹
const fmSynth = new Tone.FMSynth({
  harmonicity: 1.5, // å€éŸ³ã®æ¯”ç‡ã‚’å¤‰ãˆã¦ã‚ˆã‚Šé‡‘å±çš„ã«
  modulationIndex: 15, // æ•°å€¤ã‚’ä¸Šã’ã‚‹ã¨ã‚ˆã‚Šæ˜ã‚‹ãæ­ªã‚€
  oscillator: { type: "sine" },
  modulation: { type: "sawtooth" }, // å¤‰èª¿å´ã‚’ãƒã‚³ã‚®ãƒªæ³¢ã«ã—ã¦æ¿€ã—ã
  envelope: { attack: 0.01, decay: 0.2, sustain: 0.8, release: 0.5 }, // ã‚µã‚¹ãƒ†ã‚£ãƒ³é«˜ã‚ã§éŸ³ã‚’æ®‹ã™
  volume: -4
}).toDestination();

// ==========================================
// å¤‰æ•°ãƒ»è¨­å®š
// ==========================================
let usePatternA = true;
let isPlaying = false; 
let currentNoteIndex = 0; 
let smoothedBPM = 60; 

let motionHistory = [];
const HISTORY_DURATION = 2000; 

const patterns = {
  A: ["D4","C4","B3","D4", "C4","A3", "G3","A3", "B3"],
  B: ["D4","C4","B3","D4", "C4","A3", "G3","B3", "G3"]
};

const durations = [0.25, 0.25, 0.25, 0.25, 0.5, 0.5, 0.5, 0.5, 1.0];

function noteToFreq(note, offset = 0) {
  const map = {
    G3: -14, A3: -12, B3: -10,
    C4: -9,  D4: -7,  E4: -5, F4: -4, G4: -2, A4: 0, B4: 2,
    C5: 3
  };
  let semitone = map[note];
  if (semitone === undefined) semitone = 0;
  semitone += offset;
  return 440 * Math.pow(2, semitone/12);
}

// ==========================================
// é–‹å§‹å‡¦ç†ï¼ˆâ˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸâ˜…ï¼‰
// ==========================================
document.getElementById("start").onclick = async () => {
  // 1. å…ˆã«ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’æ±‚ã‚ã‚‹ (iOSå¯¾ç­–)
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    try {
      const permissionState = await DeviceMotionEvent.requestPermission();
      if (permissionState !== 'granted') {
        alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
        return;
      }
    } catch (e) {
      console.error(e);
    }
  }

  // 2. ãã®å¾Œã«Tone.jsã‚’é–‹å§‹
  await Tone.start();
  
  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "ã‚»ãƒ³ã‚µãƒ¼å¾…æ©Ÿä¸­...æŒ¯ã£ã¦ãã ã•ã„";
  document.getElementById("start").style.display = "none";
};

// ==========================================
// ã‚»ãƒ³ã‚µãƒ¼å‡¦ç†
// ==========================================
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  motionHistory.push({ time: now, val: mag });
  motionHistory = motionHistory.filter(item => now - item.time < HISTORY_DURATION);

  let sum = 0;
  motionHistory.forEach(item => sum += item.val);
  const avgMag = sum / motionHistory.length || 0;

  smoothedBPM = mapAccelToBPM(avgMag);
  
  const isHighSpeed = smoothedBPM >= 120;
  document.getElementById("debug").innerText = 
    `Avg BPM: ${Math.floor(smoothedBPM)} ${isHighSpeed ? "ğŸ”¥HIGH (MonoSynth)" : ""}`;

  if (!isPlaying && mag > 15) { 
    startSequence();
  }
}

function mapAccelToBPM(a) {
  let bpm = 100 + (a - 10) * 8; 
  if (bpm < 60) bpm = 60;
  if (bpm > 200) bpm = 200;
  return bpm;
}

// ==========================================
// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ¶å¾¡
// ==========================================
function startSequence() {
  isPlaying = true;
  currentNoteIndex = 0;
  playNextNote(); 
}

function playNextNote() {
  const currentPattern = usePatternA ? patterns.A : patterns.B;
  
  if (currentNoteIndex >= currentPattern.length) {
    finishSequence();
    return;
  }

  const noteName = currentPattern[currentNoteIndex];
  const durationVal = durations[currentNoteIndex];

  const beatDuration = 60 / smoothedBPM; 
  const noteTimeLen = beatDuration * durationVal;

  const isHighSpeed = smoothedBPM >= 120;
  const pitchOffset = isHighSpeed ? 1 : 0;
  const freq = noteToFreq(noteName, pitchOffset);

  playSoundWithTone(freq, noteTimeLen, isHighSpeed);
  
  let instrumentName = "PolySynth";
  if (isHighSpeed) instrumentName = "MonoSynth";
  else if (!usePatternA) instrumentName = "FMSynth";

  document.getElementById("status").innerText = 
    `å†ç”Ÿä¸­: ${usePatternA?"A":"B"} (${currentNoteIndex+1}/${currentPattern.length}) - ${instrumentName}`;

  setTimeout(() => {
    currentNoteIndex++;
    playNextNote(); 
  }, noteTimeLen * 1000); 
}

function playSoundWithTone(freq, duration, isHighSpeed) {
  let synthToUse;

  // BPMã«å¿œã˜ã¦3æ®µéšã«åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯
  // 60ã€œ100: Poly (ã“ã‚‚ã‚‹)
  // 100ã€œ140: Mono (å¤ªããªã‚‹)
  // 140ä»¥ä¸Š : FM (æ´¾æ‰‹ã«é–‹ã‘ã‚‹)

  if (smoothedBPM < 100) {
    synthToUse = polySynth;      // ç¬¬ä¸€å½¢æ…‹ï¼šé™ã‹
  } else if (smoothedBPM < 140) {
    synthToUse = monoSynth;      // ç¬¬äºŒå½¢æ…‹ï¼šåŠ›å¼·ã„
  } else {
    synthToUse = fmSynth;        // æœ€çµ‚å½¢æ…‹ï¼šè¦šé†’
  }
  synthToUse.triggerAttackRelease(freq, duration);
}

function finishSequence() {
  isPlaying = false;
  usePatternA = !usePatternA; 
  document.getElementById("status").innerText = "å¾…æ©Ÿä¸­...";
}
</script>

</body>
</html>